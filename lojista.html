<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lojista - Marcelo Entregas</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-md mx-auto">
        <div id="cadastro" class="hidden bg-white p-6 rounded-3xl shadow-xl">
            <h2 class="text-center font-black mb-4">CADASTRO DA LOJA</h2>
            <input id="nLoja" placeholder="Nome da Loja" class="w-full p-4 mb-2 bg-gray-50 rounded-xl border">
            <input id="zLoja" placeholder="WhatsApp (Ex: 14999999999)" class="w-full p-4 mb-2 bg-gray-50 rounded-xl border">
            <input id="eLoja" placeholder="Endere√ßo Completo da Loja" class="w-full p-4 mb-4 bg-gray-50 rounded-xl border">
            <button onclick="salvarLoja()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold">SALVAR</button>
        </div>

        <div id="painel" class="hidden space-y-4">
            <div class="bg-white p-4 rounded-2xl shadow flex justify-between items-center font-bold text-xs">
                <span id="exibirNome"></span>
                <span id="stStatus">...</span>
            </div>

            <button id="btnChamada" onclick="chamarNoSistema()" class="w-full bg-orange-500 text-white p-5 rounded-2xl font-black shadow-lg">üîî CHAMAR MARCELO AGORA</button>

            <div class="bg-white p-6 rounded-3xl shadow-lg">
                <p class="font-black text-xs text-gray-400 mb-2 italic">DESTINO DA ENTREGA:</p>
                <input id="inputEnd" placeholder="Rua e N√∫mero" class="w-full p-4 mb-2 bg-blue-50 rounded-xl font-bold">
                <input id="inputBairro" placeholder="Bairro e Cidade" class="w-full p-4 mb-4 bg-blue-50 rounded-xl font-bold">
                
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <select id="pagamento" class="p-4 bg-gray-50 rounded-xl font-bold text-xs">
                        <option value="J√Å PAGO">J√Å PAGO ‚úÖ</option>
                        <option value="DINHEIRO">DINHEIRO üíµ</option>
                        <option value="MAQUININHA">MAQUININHA üí≥</option>
                        <option value="PIX">PIX üì±</option>
                    </select>
                    <input id="trocoPara" type="number" placeholder="Troco?" class="p-4 bg-gray-50 rounded-xl border font-bold">
                </div>
                <button onclick="addLista()" class="w-full bg-slate-800 text-white p-4 rounded-xl font-black mb-4">+ ADICIONAR</button>
                <div id="listaRascunho" class="space-y-2 mb-4"></div>
                <button id="btnEnviarLote" onclick="enviarLote()" class="hidden w-full bg-green-600 text-white p-5 rounded-2xl font-black shadow-xl">ENVIAR TODOS ‚úÖ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBjP9dxFEp09DpZl5JkVMD05uaKoQTNDpE", authDomain: "meuappentregas.firebaseapp.com", projectId: "meuappentregas", storageBucket: "meuappentregas.firebasestorage.app", messagingSenderId: "442484186787", appId: "1:442484186787:web:ac914827ebebda987f2916" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        let dadosLoja = JSON.parse(localStorage.getItem('marcelo_loja'));
        let rascunho = [];

        window.onload = () => {
            if(!dadosLoja) document.getElementById('cadastro').classList.remove('hidden');
            else {
                document.getElementById('painel').classList.remove('hidden');
                document.getElementById('exibirNome').innerText = dadosLoja.nome;
                onSnapshot(doc(db, "config", "status"), (d) => {
                    const s = d.data() || {};
                    document.getElementById('stStatus').innerText = s.online ? "ONLINE üü¢" : "OFFLINE üî¥";
                });
            }
        };

        window.chamarNoSistema = async () => {
            const btn = document.getElementById('btnChamada');
            btn.innerText = "CHAMANDO...";
            const docRef = await addDoc(collection(db, "chamadas"), { loja: dadosLoja.nome, enderecoLoja: dadosLoja.endereco, zap: dadosLoja.zap, hora: Date.now(), status: "Pendente" });
            onSnapshot(doc(db, "chamadas", docRef.id), (d) => {
                if (d.exists() && d.data().status === "Visualizado") {
                    btn.innerText = "‚úÖ MARCELO EST√Å VINDO!";
                    btn.className = "w-full bg-green-600 text-white p-5 rounded-2xl font-black";
                }
            });
        };

        window.addLista = () => {
            const rua = document.getElementById('inputEnd').value;
            const bairro = document.getElementById('inputBairro').value;
            const pag = document.getElementById('pagamento').value;
            const troco = document.getElementById('trocoPara').value;
            if(rua) {
                let info = pag + (troco ? ` (Troco R$${troco})` : "");
                rascunho.push({ local: `${rua} - ${bairro}`, pag: info });
                document.getElementById('inputEnd').value = ''; render();
            }
        };

        function render() {
            document.getElementById('listaRascunho').innerHTML = rascunho.map((e, i) => `<div class="p-3 bg-white rounded-xl shadow-sm border-l-4 border-blue-600 flex justify-between text-xs font-bold uppercase italic"><span>${e.local}</span><button onclick="rascunho.splice(${i},1);render()" class="text-red-500">X</button></div>`).join('');
            document.getElementById('btnEnviarLote').classList.toggle('hidden', rascunho.length === 0);
        }

        window.enviarLote = async () => {
            for (const item of rascunho) {
                await addDoc(collection(db, "pedidos"), { loja: dadosLoja.nome, zap: dadosLoja.zap, local: item.local, pag: item.pag, hora: Date.now() });
            }
            rascunho = []; render(); alert("Enviado com sucesso!");
        };

        window.salvarLoja = () => {
            const n = document.getElementById('nLoja').value;
            const z = document.getElementById('zLoja').value;
            const e = document.getElementById('eLoja').value;
            if(n && z && e) { localStorage.setItem('marcelo_loja', JSON.stringify({nome: n, zap: z, endereco: e})); location.reload(); }
        };
    </script>
</body>
</html>
