<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loja - Entrega</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyBjP9dxFEp09DpZl5JkVMD05uaKoQTNDpE", authDomain: "meuappentregas.firebaseapp.com", projectId: "meuappentregas", storageBucket: "meuappentregas.firebasestorage.app", messagingSenderId: "442484186787", appId: "1:442484186787:web:ac914827ebebda987f2916" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);
        const perfil = JSON.parse(localStorage.getItem('perfilMarcelo'));
        let rascunho = [];

        window.chamarMoto = async () => {
            await addDoc(collection(db, "chamados"), { loja: perfil.nome, status: "Pendente", timestamp: Date.now() });
        };

        window.addLista = () => {
            const e = document.getElementById('end').value;
            if(e) { rascunho.push(e); document.getElementById('end').value = ""; render(); }
        };

        window.render = () => {
            document.getElementById('lista').innerHTML = rascunho.map(t => `<div class="p-2 bg-gray-100 mb-1 rounded text-sm">${t}</div>`).join('');
            document.getElementById('btnEnviar').classList.toggle('hidden', rascunho.length === 0);
        };

        window.enviarTudo = async () => {
            for (const l of rascunho) {
                await addDoc(collection(db, "pedidos"), { loja: perfil.nome, local: l, status: "Fila", timestamp: Date.now(), zap: perfil.zap });
            }
            rascunho = []; render(); alert("Lote enviado!");
        };

        window.onload = () => {
            if(!perfil) return document.getElementById('cad').classList.remove('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('nLoja').innerText = perfil.nome;
            onSnapshot(doc(db, "config", "status"), (d) => {
                const s = d.data();
                const st = document.getElementById('st');
                st.innerText = s?.ocupado ? "ENTREGADOR EM ROTA ðŸ›µ" : (s?.online ? "ENTREGADOR ONLINE ðŸŸ¢" : "ENTREGADOR OFFLINE ðŸ”´");
            });
        };

        window.salvar = () => {
            localStorage.setItem('perfilMarcelo', JSON.stringify({ nome: document.getElementById('n').value, zap: document.getElementById('z').value }));
            location.reload();
        };
    </script>
</head>
<body class="bg-gray-50 p-4 font-sans">
    <div id="cad" class="max-w-md mx-auto hidden bg-white p-6 rounded-3xl shadow-xl">
        <input id="n" placeholder="Nome da Loja" class="w-full p-4 mb-2 bg-gray-100 rounded-xl">
        <input id="z" placeholder="WhatsApp" class="w-full p-4 mb-4 bg-gray-100 rounded-xl">
        <button onclick="salvar()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl">CONFIGURAR</button>
    </div>
    <div id="app" class="max-w-md mx-auto hidden space-y-4">
        <div class="flex justify-between items-center px-2"><span id="nLoja" class="font-black text-blue-900 uppercase"></span> <span id="st" class="text-[10px] font-bold"></span></div>
        <button onclick="chamarMoto()" class="w-full bg-blue-600 text-white font-bold py-6 rounded-3xl shadow-lg uppercase italic">Solicitar Entregador</button>
        <div class="bg-white p-5 rounded-3xl shadow">
            <input id="end" placeholder="EndereÃ§o da Entrega" class="w-full p-4 bg-gray-50 rounded-xl mb-2 font-bold">
            <button onclick="addLista()" class="w-full bg-gray-200 text-gray-700 font-bold py-3 rounded-xl">+ ADICIONAR ENDEREÃ‡O</button>
            <div id="lista" class="mt-4"></div>
            <button id="btnEnviar" onclick="enviarTudo()" class="w-full bg-green-600 text-white font-black py-4 rounded-xl mt-4 hidden shadow-md">ENVIAR LOTE COMPLETO âœ…</button>
        </div>
    </div>
</body>
</html>
