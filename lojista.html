<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Marcelo Entregas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .btn-press { transition: transform 0.1s; }
        .btn-press:active { transform: scale(0.95); }
        
        .input-focus:focus {
            transform: scale(1.02);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2);
        }
        
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .pulse-soft {
            animation: pulseSoft 2s infinite;
        }
        @keyframes pulseSoft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* Teclado num√©rico grande */
        .num-key {
            @apply h-16 text-2xl font-black bg-white rounded-2xl shadow active:bg-blue-50 btn-press;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans h-screen overflow-hidden flex flex-col">

    <!-- CADASTRO (Primeiro acesso) -->
    <div id="cadastro" class="hidden flex-1 flex flex-col p-4 overflow-y-auto">
        <div class="flex-1 flex flex-col justify-center max-w-md mx-auto w-full">
            <div class="text-center mb-8">
                <div class="w-24 h-24 bg-gradient-to-br from-blue-600 to-blue-800 rounded-3xl mx-auto mb-4 flex items-center justify-center text-white text-4xl shadow-xl">
                    üè™
                </div>
                <h1 class="text-2xl font-black text-gray-800">Bem-vindo!</h1>
                <p class="text-gray-500 mt-2">Configure sua loja</p>
            </div>
            
            <div class="space-y-4">
                <div class="bg-white p-4 rounded-2xl shadow-sm">
                    <label class="text-xs font-bold text-blue-600 uppercase mb-1 block">Nome da Loja</label>
                    <input id="nLoja" placeholder="Ex: Mercado do Jo√£o" autocomplete="off" 
                        class="w-full text-lg font-bold outline-none bg-transparent">
                </div>
                
                <div class="bg-white p-4 rounded-2xl shadow-sm">
                    <label class="text-xs font-bold text-blue-600 uppercase mb-1 block">WhatsApp (somente n√∫meros)</label>
                    <input id="zLoja" placeholder="14999999999" type="tel" maxlength="11" autocomplete="off" 
                        class="w-full text-lg font-bold outline-none bg-transparent" inputmode="numeric">
                </div>
                
                <div class="bg-white p-4 rounded-2xl shadow-sm">
                    <label class="text-xs font-bold text-blue-600 uppercase mb-1 block">Endere√ßo da Loja</label>
                    <input id="eLoja" placeholder="Rua, n√∫mero, bairro" autocomplete="off" 
                        class="w-full text-lg font-bold outline-none bg-transparent">
                </div>
                
                <button onclick="salvar()" class="w-full bg-blue-600 text-white p-5 rounded-2xl font-black text-lg shadow-lg btn-press mt-6">
                    COME√áAR A USAR ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app" class="hidden flex-1 flex flex-col h-screen">
        
        <!-- HEADER FIXO -->
        <div class="bg-blue-600 text-white p-4 shadow-lg z-20">
            <div class="flex justify-between items-center max-w-md mx-auto">
                <div class="flex-1 min-w-0">
                    <p class="text-xs opacity-80">Sua Loja</p>
                    <h1 id="nomeLoja" class="text-xl font-black truncate"></h1>
                </div>
                <div class="flex items-center gap-3">
                    <div id="statusMarcelo" class="flex items-center gap-2 bg-white/20 px-3 py-2 rounded-xl">
                        <span class="w-3 h-3 rounded-full bg-gray-400 animate-pulse"></span>
                        <span class="text-sm font-bold">...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTE√öDO SCROLL√ÅVEL -->
        <div class="flex-1 overflow-y-auto hide-scrollbar pb-32">
            <div class="max-w-md mx-auto p-4 space-y-4">
                
                <!-- BOT√ÉO CHAMAR (Destaque m√°ximo) -->
                <button id="btnChamar" onclick="chamar()" disabled
                    class="w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white p-6 rounded-3xl font-black text-xl shadow-2xl btn-press disabled:opacity-50 disabled:cursor-not-allowed relative overflow-hidden">
                    <div class="absolute inset-0 bg-white/20 translate-x-[-100%] hover:translate-x-[100%] transition-transform duration-700"></div>
                    <span class="flex items-center justify-center gap-3">
                        <span class="text-3xl">üîî</span>
                        <span>CHAMAR MARCELO</span>
                    </span>
                </button>

                <!-- STATUS DO CHAMADO -->
                <div id="statusChamado" class="hidden">
                    <div id="boxPendente" class="hidden bg-yellow-100 border-2 border-yellow-400 p-4 rounded-2xl animate-pulse">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">‚è≥</span>
                            <div>
                                <p class="font-black text-yellow-800">Chamando...</p>
                                <p class="text-sm text-yellow-700">Aguarde a confirma√ß√£o</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="boxAceito" class="hidden bg-green-100 border-2 border-green-400 p-4 rounded-2xl">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">‚úÖ</span>
                            <div>
                                <p class="font-black text-green-800">Marcelo est√° vindo!</p>
                                <p class="text-sm text-green-700">Prepare as entregas</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FORMUL√ÅRIO R√ÅPIDO DE ENTREGA -->
                <div class="bg-white rounded-3xl shadow-lg overflow-hidden">
                    <div class="bg-gray-50 p-4 border-b border-gray-100">
                        <h2 class="font-black text-gray-800 flex items-center gap-2 text-lg">
                            <span class="bg-blue-100 p-2 rounded-xl text-blue-600">üì¶</span>
                            Nova Entrega
                        </h2>
                    </div>
                    
                    <div class="p-4 space-y-4">
                        <!-- Endere√ßo (Campo principal grande) -->
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Endere√ßo de Entrega</label>
                            <input id="end" placeholder="Rua, n√∫mero, bairro" autocomplete="off" 
                                class="w-full p-4 bg-blue-50 rounded-2xl text-lg font-bold outline-none input-focus transition-all"
                                onkeypress="if(event.key==='Enter') document.getElementById('ref').focus()">
                        </div>

                        <!-- Refer√™ncia -->
                        <input id="ref" placeholder="Ponto de refer√™ncia (opcional)" autocomplete="off" 
                            class="w-full p-3 bg-gray-50 rounded-xl font-bold outline-none input-focus transition-all"
                            onkeypress="if(event.key==='Enter') document.getElementById('pag').focus()">

                        <!-- Pagamento em grid -->
                        <div class="grid grid-cols-2 gap-3">
                            <select id="pag" class="p-4 bg-gray-50 rounded-xl font-bold outline-none input-focus text-sm"
                                onchange="toggleTroco()">
                                <option value="PAGO">‚úÖ Pago</option>
                                <option value="DINHEIRO">üíµ Dinheiro</option>
                                <option value="PIX">üì± PIX</option>
                                <option value="CARTAO">üí≥ Cart√£o</option>
                            </select>
                            
                            <input id="troco" type="number" placeholder="Troco p/ quanto?" 
                                class="hidden p-4 bg-yellow-50 rounded-xl font-bold outline-none input-focus text-sm placeholder:text-yellow-600/50"
                                inputmode="numeric">
                        </div>

                        <!-- Bot√£o Adicionar -->
                        <button onclick="add()" class="w-full bg-slate-800 text-white p-4 rounded-2xl font-black text-lg shadow-lg btn-press flex items-center justify-center gap-2">
                            <span class="text-2xl">+</span>
                            ADICIONAR √Ä LISTA
                        </button>
                    </div>
                </div>

                <!-- LISTA DE ENTREGAS DO DIA -->
                <div id="areaLista" class="hidden slide-up">
                    <div class="flex justify-between items-center mb-2 px-1">
                        <h3 class="font-black text-gray-700 flex items-center gap-2">
                            üìã Entregas Hoje
                            <span id="badgeQtd" class="bg-blue-600 text-white text-xs px-2 py-1 rounded-full">0</span>
                        </h3>
                        <button onclick="limparTudo()" class="text-red-500 text-sm font-bold">Limpar</button>
                    </div>
                    
                    <div id="lista" class="space-y-2"></div>
                    
                    <button onclick="enviarTudo()" id="btnEnviar" 
                        class="w-full bg-green-600 text-white p-5 rounded-2xl font-black text-lg shadow-xl btn-press mt-4 flex items-center justify-center gap-2">
                        <span>üöÄ</span>
                        ENVIAR <span id="qtdEnviar">0</span> ENTREGA(S)
                    </button>
                </div>

                <!-- ENTREGAS ATIVAS (do Firebase) -->
                <div class="bg-white rounded-3xl shadow-lg p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-black text-gray-800">üöö Em Andamento</h3>
                        <span id="contadorAtivas" class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded-full font-bold">0</span>
                    </div>
                    <div id="minhas" class="space-y-2 max-h-48 overflow-y-auto hide-scrollbar">
                        <p class="text-gray-400 text-center py-4 text-sm">Nenhuma entrega ativa</p>
                    </div>
                </div>

            </div>
        </div>

        <!-- BARRA INFERIOR FIXA -->
        <div class="bg-white border-t border-gray-200 p-4 shadow-lg z-20">
            <div class="max-w-md mx-auto flex justify-around">
                <button onclick="scrollToTop()" class="flex flex-col items-center gap-1 text-blue-600">
                    <span class="text-2xl">üì¶</span>
                    <span class="text-xs font-bold">Nova</span>
                </button>
                <button onclick="document.getElementById('minhas').scrollIntoView({behavior: 'smooth'})" class="flex flex-col items-center gap-1 text-gray-400">
                    <span class="text-2xl">üöö</span>
                    <span class="text-xs font-bold">Ativas</span>
                </button>
                <button onclick="location.reload()" class="flex flex-col items-center gap-1 text-gray-400">
                    <span class="text-2xl">üîÑ</span>
                    <span class="text-xs font-bold">Atualizar</span>
                </button>
            </div>
        </div>

    </div>

    <!-- MODAL DE CONFIRMA√á√ÉO -->
    <div id="modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm slide-up">
            <div class="text-center mb-4">
                <div class="w-16 h-16 bg-green-100 rounded-full mx-auto flex items-center justify-center text-3xl mb-2">‚úÖ</div>
                <h3 class="font-black text-xl text-gray-800">Entregas Enviadas!</h3>
                <p class="text-gray-500 text-sm">Marcelo foi notificado</p>
            </div>
            <button onclick="fecharModal()" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-black btn-press">
                OK, VOLTAR
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, doc, 
            updateDoc, Timestamp, query, where, getDocs, deleteDoc 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBjP9dxFEp09DpZl5JkVMD05uaKoQTNDpE", 
            authDomain: "meuappentregas.firebaseapp.com", 
            projectId: "meuappentregas", 
            storageBucket: "meuappentregas.firebasestorage.app", 
            messagingSenderId: "442484186787", 
            appId: "1:442484186787:web:ac914827ebebda987f2916" 
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let loja = JSON.parse(localStorage.getItem('marcelo_loja'));
        let rascunho = [];
        let meuChamadoAtivo = null;

        // Inicializa√ß√£o
        function init() {
            if (!loja || !loja.endereco) {
                document.getElementById('cadastro').classList.remove('hidden');
                document.getElementById('nLoja').focus();
            } else {
                iniciarApp();
            }
        }

        function iniciarApp() {
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('nomeLoja').textContent = loja.nome;

            // Monitorar status do Marcelo
            onSnapshot(doc(db, 'config', 'status'), (doc) => {
                const s = doc.data() || { online: false, ocupado: false };
                const el = document.getElementById('statusMarcelo');
                const btn = document.getElementById('btnChamar');
                
                if (s.online && !s.ocupado) {
                    el.innerHTML = '<span class="w-3 h-3 rounded-full bg-green-400"></span><span class="text-sm font-bold">Online</span>';
                    el.className = 'flex items-center gap-2 bg-green-500 text-white px-3 py-2 rounded-xl';
                    btn.disabled = false;
                } else if (s.ocupado) {
                    el.innerHTML = '<span class="w-3 h-3 rounded-full bg-orange-400 animate-pulse"></span><span class="text-sm font-bold">Ocupado</span>';
                    el.className = 'flex items-center gap-2 bg-orange-500 text-white px-3 py-2 rounded-xl';
                    btn.disabled = true;
                } else {
                    el.innerHTML = '<span class="w-3 h-3 rounded-full bg-red-400"></span><span class="text-sm font-bold">Offline</span>';
                    el.className = 'flex items-center gap-2 bg-red-500 text-white px-3 py-2 rounded-xl';
                    btn.disabled = true;
                }
            });

            // Monitorar MEUS chamados
            const q = query(collection(db, 'chamadas'), where('loja', '==', loja.nome));
            onSnapshot(q, (snap) => {
                let chamado = null;
                snap.forEach((d) => {
                    const c = d.data();
                    if (['Pendente', 'Visualizado'].includes(c.status)) {
                        chamado = { id: d.id, ...c };
                    }
                });
                atualizarUIChamado(chamado);
            });

            carregarEntregas();
            setInterval(carregarEntregas, 10000);
            
            // Focar no campo principal
            setTimeout(() => document.getElementById('end').focus(), 100);
        }

        function atualizarUIChamado(chamado) {
            const box = document.getElementById('statusChamado');
            const pendente = document.getElementById('boxPendente');
            const aceito = document.getElementById('boxAceito');
            const btn = document.getElementById('btnChamar');
            
            meuChamadoAtivo = chamado;

            if (chamado) {
                box.classList.remove('hidden');
                btn.disabled = true;
                btn.innerHTML = '<span class="flex items-center justify-center gap-2"><span class="animate-spin">‚è≥</span><span>AGUARDANDO...</span></span>';
                
                if (chamado.status === 'Pendente') {
                    pendente.classList.remove('hidden');
                    aceito.classList.add('hidden');
                } else {
                    pendente.classList.add('hidden');
                    aceito.classList.remove('hidden');
                }
            } else {
                box.classList.add('hidden');
                btn.disabled = false;
                btn.innerHTML = '<span class="flex items-center justify-center gap-3"><span class="text-3xl">üîî</span><span>CHAMAR MARCELO</span></span>';
            }
        }

        // A√ß√µes
        window.chamar = async () => {
            if (meuChamadoAtivo) return;
            
            const btn = document.getElementById('btnChamar');
            btn.disabled = true;
            
            try {
                // Anti-duplicata
                const q = query(
                    collection(db, 'chamadas'), 
                    where('loja', '==', loja.nome),
                    where('status', 'in', ['Pendente', 'Visualizado'])
                );
                const existentes = await getDocs(q);
                if (!existentes.empty) return;

                let coords = null;
                try {
                    const pos = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
                    });
                    coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                } catch (e) {}

                await addDoc(collection(db, 'chamadas'), {
                    loja: loja.nome,
                    zap: loja.zap,
                    enderecoLoja: loja.endereco,
                    coords: coords,
                    hora: Timestamp.now(),
                    status: 'Pendente'
                });
            } catch (e) {
                alert('Erro: ' + e.message);
                btn.disabled = false;
            }
        };

        window.toggleTroco = () => {
            const pag = document.getElementById('pag').value;
            const troco = document.getElementById('troco');
            const mostrar = ['DINHEIRO', 'PIX'].includes(pag);
            
            troco.classList.toggle('hidden', !mostrar);
            if (mostrar) {
                troco.focus();
                troco.classList.add('animate-pulse');
                setTimeout(() => troco.classList.remove('animate-pulse'), 1000);
            }
        };

        window.add = () => {
            const rua = document.getElementById('end').value.trim();
            if (!rua) {
                document.getElementById('end').focus();
                return;
            }
            
            let pag = document.getElementById('pag').value;
            const troco = document.getElementById('troco').value;
            if (troco && ['DINHEIRO', 'PIX'].includes(pag)) {
                pag += ` (Troco: R$${troco})`;
            }
            
            rascunho.push({
                local: rua,
                ref: document.getElementById('ref').value,
                pag: pag,
                id: Date.now()
            });
            
            // Limpar e focar
            document.getElementById('end').value = '';
            document.getElementById('ref').value = '';
            document.getElementById('troco').value = '';
            document.getElementById('pag').value = 'PAGO';
            document.getElementById('troco').classList.add('hidden');
            
            atualizarLista();
            document.getElementById('end').focus();
            
            // Feedback visual
            document.getElementById('areaLista').scrollIntoView({ behavior: 'smooth', block: 'center' });
        };

        function atualizarLista() {
            const area = document.getElementById('areaLista');
            const lista = document.getElementById('lista');
            const badge = document.getElementById('badgeQtd');
            const btn = document.getElementById('btnEnviar');
            const qtd = document.getElementById('qtdEnviar');
            
            if (rascunho.length === 0) {
                area.classList.add('hidden');
                return;
            }
            
            area.classList.remove('hidden');
            badge.textContent = rascunho.length;
            qtd.textContent = rascunho.length;
            
            lista.innerHTML = rascunho.map((item, i) => `
                <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-blue-500 flex justify-between items-center">
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-gray-800 truncate">${item.local}</p>
                        <p class="text-sm text-blue-600 font-bold">${item.pag}</p>
                        ${item.ref ? `<p class="text-xs text-gray-500 truncate">Ref: ${item.ref}</p>` : ''}
                    </div>
                    <button onclick="remover(${i})" class="w-10 h-10 bg-red-100 text-red-500 rounded-xl font-black text-xl btn-press ml-2">
                        √ó
                    </button>
                </div>
            `).join('');
        }

        window.remover = (i) => {
            rascunho.splice(i, 1);
            atualizarLista();
        };

        window.limparTudo = () => {
            if (confirm('Limpar todas as entregas da lista?')) {
                rascunho = [];
                atualizarLista();
            }
        };

        window.enviarTudo = async () => {
            const btn = document.getElementById('btnEnviar');
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin inline-block mr-2">‚è≥</span>ENVIANDO...';
            
            try {
                for (const item of rascunho) {
                    await addDoc(collection(db, 'pedidos'), {
                        loja: loja.nome,
                        zap: loja.zap,
                        local: item.local,
                        referencia: item.ref,
                        pag: item.pag,
                        status: 'Ativo',
                        hora: Timestamp.now()
                    });
                }
                
                rascunho = [];
                atualizarLista();
                document.getElementById('modal').classList.remove('hidden');
                
            } catch (e) {
                alert('Erro: ' + e.message);
                btn.disabled = false;
                btn.innerHTML = '<span>üöÄ</span>ENVIAR <span id="qtdEnviar">' + rascunho.length + '</span> ENTREGA(S)';
            }
        };

        window.fecharModal = () => {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('btnEnviar').disabled = false;
            document.getElementById('btnEnviar').innerHTML = '<span>üöÄ</span>ENVIAR <span id="qtdEnviar">0</span> ENTREGA(S)';
            document.getElementById('end').focus();
        };

        async function carregarEntregas() {
            const div = document.getElementById('minhas');
            const contador = document.getElementById('contadorAtivas');
            
            const q = query(collection(db, 'pedidos'), where('loja', '==', loja.nome));
            const snap = await getDocs(q);
            const entregas = [];
            
            snap.forEach(d => {
                const p = d.data();
                if (p.status !== 'Concluido') entregas.push({ id: d.id, ...p });
            });

            contador.textContent = entregas.length;
            
            if (entregas.length === 0) {
                div.innerHTML = '<p class="text-gray-400 text-center py-4 text-sm">Nenhuma entrega ativa</p>';
                return;
            }

            const icons = { 'Ativo': '‚è≥', 'SaiuParaEntrega': 'üõµ', 'Chegou': '‚úÖ' };
            const colors = { 'Ativo': 'blue', 'SaiuParaEntrega': 'orange', 'Chegou': 'green' };
            
            div.innerHTML = entregas.map(p => `
                <div class="bg-gray-50 p-3 rounded-xl border-l-4 border-${colors[p.status] || 'gray'}-500 flex justify-between items-center">
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-sm text-gray-800 truncate">${p.local}</p>
                        <p class="text-xs text-${colors[p.status] || 'gray'}-600 font-bold">${p.pag}</p>
                    </div>
                    <span class="text-xl" title="${p.status}">${icons[p.status] || '‚è≥'}</span>
                </div>
            `).join('');
        }

        window.salvar = () => {
            const n = document.getElementById('nLoja').value.trim();
            const z = document.getElementById('zLoja').value.trim();
            const e = document.getElementById('eLoja').value.trim();
            
            if (!n || !z || !e) return alert('Preencha todos os campos');
            if (z.length !== 11) return alert('WhatsApp deve ter 11 d√≠gitos');
            
            localStorage.setItem('marcelo_loja', JSON.stringify({ nome: n, zap: z, endereco: e }));
            location.reload();
        };

        window.scrollToTop = () => {
            document.querySelector('.overflow-y-auto').scrollTo({ top: 0, behavior: 'smooth' });
            setTimeout(() => document.getElementById('end').focus(), 300);
        };

        init();
    </script>
</body>
</html>
