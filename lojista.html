<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loja - Painel de Entregas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">
    <div class="max-w-md mx-auto">
        <div id="telaCadastro" class="hidden bg-white rounded-3xl shadow-xl p-6 mt-10">
            <h1 class="text-2xl font-black text-center text-blue-900 mb-6">üè™ Configurar Loja</h1>
            <input id="inputNome" placeholder="Nome da Loja" class="w-full p-4 mb-3 bg-gray-100 rounded-xl outline-none">
            <input id="inputZap" placeholder="WhatsApp (com DDD)" class="w-full p-4 mb-6 bg-gray-100 rounded-xl outline-none" type="tel">
            <button onclick="salvarPerfil()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl">SALVAR</button>
        </div>

        <div id="telaApp" class="hidden space-y-4 pb-20">
            <div class="bg-white rounded-2xl shadow p-4 flex justify-between items-center border-b-4 border-blue-600">
                <div>
                    <h1 id="nomeLojaDisplay" class="font-black text-blue-900 text-lg uppercase"></h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="statusDot" class="w-2 h-2 rounded-full bg-gray-400"></span>
                        <span id="statusText" class="text-xs text-gray-500 font-bold uppercase">Verificando...</span>
                    </div>
                </div>
                <button onclick="sair()" class="text-gray-400 text-xs font-bold uppercase">Sair</button>
            </div>

            <button onclick="chamarEntregador('urgente')" id="btnUrgente" class="w-full bg-red-600 text-white font-black py-5 rounded-2xl shadow-lg hidden italic">üö® PRECISO AGORA (URGENTE)</button>
            <button onclick="chamarEntregador('normal')" id="btnNormal" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl shadow-lg hidden italic">üèçÔ∏è SOLICITAR ENTREGADOR</button>
            
            <div id="msgStatus" class="bg-orange-100 border-l-4 border-orange-500 p-4 rounded-r-xl hidden">
                <p id="msgTexto" class="text-sm text-orange-700 font-bold"></p>
            </div>

            <div class="bg-white rounded-3xl shadow-lg p-4">
                <h3 class="font-black text-gray-700 mb-3 uppercase text-sm">üì¶ Montar Lote</h3>
                <div class="flex gap-2 mb-3">
                    <input type="text" id="inputEndereco" placeholder="Endere√ßo completo" class="flex-1 p-3 bg-gray-50 rounded-xl border-none outline-none text-sm font-bold">
                    <button onclick="adicionarEndereco()" class="bg-blue-600 text-white px-5 rounded-xl font-black text-xl">+</button>
                </div>
                <div id="listaEnderecos" class="space-y-2 mb-4"></div>
                <div id="resumoEnvio" class="hidden border-t pt-3">
                    <button onclick="enviarLote()" id="btnEnviar" class="w-full bg-green-600 text-white font-black py-4 rounded-xl shadow-md">ENVIAR LOTE COMPLETO ‚úÖ</button>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-lg p-4">
                <h3 class="font-black text-gray-700 mb-3 uppercase text-sm">üìã Meus Pedidos Ativos</h3>
                <div id="meusPedidos" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, serverTimestamp, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBjP9dxFEp09DpZl5JkVMD05uaKoQTNDpE", authDomain: "meuappentregas.firebaseapp.com", projectId: "meuappentregas", storageBucket: "meuappentregas.firebasestorage.app", messagingSenderId: "442484186787", appId: "1:442484186787:web:ac914827ebebda987f2916" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        let perfil = JSON.parse(localStorage.getItem('perfilLoja'));
        let rascunho = [];

        window.onload = () => {
            if (perfil) mostrarApp();
            else document.getElementById('telaCadastro').classList.remove('hidden');
        };

        window.salvarPerfil = () => {
            const nome = document.getElementById('inputNome').value;
            const zap = document.getElementById('inputZap').value.replace(/\D/g, '');
            if (nome && zap) {
                perfil = { id: 'loja_' + Date.now(), nome, zap };
                localStorage.setItem('perfilLoja', JSON.stringify(perfil));
                location.reload();
            }
        };

        function mostrarApp() {
            document.getElementById('telaCadastro').classList.add('hidden');
            document.getElementById('telaApp').classList.remove('hidden');
            document.getElementById('nomeLojaDisplay').textContent = perfil.nome;

            onSnapshot(doc(db, "sistema", "status"), (doc) => {
                const s = doc.data() || {};
                const dot = document.getElementById('statusDot');
                const txt = document.getElementById('statusText');
                const msg = document.getElementById('msgStatus');
                const bU = document.getElementById('btnUrgente');
                const bN = document.getElementById('btnNormal');

                if (s.ocupado) {
                    dot.className = 'w-2 h-2 rounded-full bg-orange-500 animate-pulse';
                    txt.innerText = 'EM ROTA üõµ';
                    msg.classList.remove('hidden');
                    document.getElementById('msgTexto').innerText = "Marcelo est√° em outra entrega. J√° pode enviar seu lote, ele ver√° em seguida.";
                    bU.classList.add('hidden'); bN.classList.add('hidden');
                } else if (s.online) {
                    dot.className = 'w-2 h-2 rounded-full bg-green-500 animate-pulse';
                    txt.innerText = 'ONLINE üü¢';
                    msg.classList.add('hidden');
                    bU.classList.remove('hidden'); bN.classList.remove('hidden');
                } else {
                    dot.className = 'w-2 h-2 rounded-full bg-red-500';
                    txt.innerText = 'OFFLINE üî¥';
                    msg.classList.remove('hidden');
                    document.getElementById('msgTexto').innerText = "O entregador est√° offline no momento.";
                    bU.classList.add('hidden'); bN.classList.add('hidden');
                }
            });

            const q = query(collection(db, "pedidos"), where("lojaId", "==", perfil.id), where("status", "in", ["Fila", "Em rota"]), orderBy("timestamp", "desc"));
            onSnapshot(q, (snaps) => {
                const container = document.getElementById('meusPedidos');
                container.innerHTML = snaps.docs.length ? '' : '<p class="text-center text-gray-400 text-xs">Sem pedidos ativos</p>';
                snaps.forEach(d => {
                    const p = d.data();
                    container.innerHTML += `<div class="p-3 bg-gray-50 rounded-xl flex justify-between border-l-4 ${p.status === 'Em rota' ? 'border-blue-500' : 'border-gray-300'}"><span class="text-xs font-bold text-gray-700">${p.local}</span><span class="text-[10px] font-black uppercase">${p.status}</span></div>`;
                });
            });
        }

        window.chamarEntregador = async (tipo) => {
            await addDoc(collection(db, "chamados"), { tipo, loja: perfil.nome, zap: perfil.zap, status: "Pendente", timestamp: serverTimestamp() });
            alert("Chamado enviado!");
        };

        window.adicionarEndereco = () => {
            const input = document.getElementById('inputEndereco');
            if(input.value) {
                rascunho.push(input.value);
                input.value = '';
                renderRascunho();
            }
        };

        function renderRascunho() {
            const container = document.getElementById('listaEnderecos');
            container.innerHTML = rascunho.map((e, i) => `<div class="flex justify-between p-2 bg-blue-50 rounded-lg text-sm font-bold"><span>${e}</span><button onclick="rascunho.splice(${i},1);renderRascunho()" class="text-red-500">X</button></div>`).join('');
            document.getElementById('resumoEnvio').classList.toggle('hidden', rascunho.length === 0);
        }

        window.enviarLote = async () => {
            for (const local of rascunho) {
                await addDoc(collection(db, "pedidos"), { lojaId: perfil.id, loja: perfil.nome, zap: perfil.zap, local, status: "Fila", timestamp: serverTimestamp(), valorEstimado: 7 });
            }
            rascunho = []; renderRascunho();
        };

        window.sair = () => { localStorage.removeItem('perfilLoja'); location.reload(); };
    </script>
</body>
</html>
