<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Lojista - Marcelo Entregas</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4 font-sans text-slate-800">
    <div class="max-w-md mx-auto">
        <div id="cadastro" class="hidden bg-white p-8 rounded-[30px] shadow-2xl">
            <h2 class="text-2xl font-black text-blue-900 mb-6 uppercase text-center italic">Configurar Loja</h2>
            <input id="nLoja" placeholder="Nome da sua Loja" class="w-full p-4 mb-3 bg-gray-50 rounded-2xl border-2 border-gray-100 outline-none font-bold italic">
            <input id="zLoja" placeholder="WhatsApp (Ex: 14999999999)" class="w-full p-4 mb-6 bg-gray-50 rounded-2xl border-2 border-gray-100 outline-none font-bold italic">
            <button onclick="salvarLoja()" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl shadow-lg uppercase italic">Salvar e Come√ßar</button>
        </div>

        <div id="painel" class="hidden space-y-4">
            <div class="bg-white p-5 rounded-3xl shadow-md flex justify-between items-center border-b-4 border-blue-600">
                <h1 id="exibirNome" class="font-black text-blue-900 uppercase italic text-sm italic"></h1>
                <span id="stStatus" class="text-[9px] font-black p-2 rounded-lg italic text-white bg-gray-400 uppercase tracking-tighter">Carregando...</span>
            </div>

            <div class="bg-white p-6 rounded-[30px] shadow-xl border border-gray-100 relative">
                <h3 class="font-black text-gray-400 text-[10px] uppercase italic mb-4 tracking-widest italic">Nova Entrega</h3>
                
                <div class="relative mb-3">
                    <input id="inputEnd" autocomplete="off" placeholder="Digite a rua e n√∫mero..." 
                        class="w-full p-5 bg-blue-50 rounded-2xl border-2 border-transparent focus:border-blue-500 font-bold outline-none transition-all text-sm"
                        oninput="autoCompletar(this.value)">
                    
                    <div id="sugestoes" class="absolute z-50 w-full bg-white shadow-2xl rounded-2xl mt-1 hidden border border-gray-100 overflow-hidden"></div>
                </div>

                <div class="flex gap-2 mb-3">
                    <select id="bairro" class="flex-1 p-4 bg-gray-50 rounded-2xl border-2 border-gray-100 font-black text-blue-900 outline-none text-[10px] uppercase italic">
                        <option value="CENTRO">üìç CENTRO</option>
                        <option value="VILA CAMPANTE">üìç VILA CAMPANTE</option>
                        <option value="VILA S√ÉO JOS√â">üìç VILA S√ÉO JOS√â</option>
                        <option value="JD. DAS FLORES">üìç JD. DAS FLORES</option>
                        <option value="JD. AM√âRICA">üìç JD. AM√âRICA</option>
                        <option value="JD. EUROPA">üìç JD. EUROPA</option>
                        <option value="OUTROS/RURAL">üìç OUTROS / RURAL</option>
                        <option value="POMP√âIA">üìç POMP√âIA (GERAL)</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-2 mb-4">
                    <select id="pagamento" class="bg-gray-50 p-4 rounded-xl font-black text-[10px] outline-none border-2 border-gray-100 uppercase italic">
                        <option value="J√Å PAGO">J√Å PAGO ‚úÖ</option>
                        <option value="DINHEIRO">DINHEIRO üíµ</option>
                        <option value="MAQUININHA">MAQUININHA üí≥</option>
                        <option value="PIX NA ENTREGA">PIX ENTREGA üì±</option>
                    </select>
                    <input id="trocoPara" type="number" placeholder="Troco R$?" class="bg-gray-50 p-4 rounded-xl font-bold text-[10px] outline-none border-2 border-gray-100">
                </div>

                <button onclick="addLista()" class="w-full bg-slate-800 text-white font-black py-4 rounded-2xl mb-4 italic hover:bg-black transition-all">+ ADICIONAR NO LOTE</button>
                
                <div id="listaRascunho" class="space-y-2 max-h-60 overflow-y-auto"></div>
                
                <button id="btnEnviarLote" onclick="enviarLote()" class="hidden w-full bg-green-600 text-white font-black py-5 rounded-2xl mt-4 shadow-lg uppercase italic text-sm animate-pulse">Enviar Tudo para o Marcelo ‚úÖ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBjP9dxFEp09DpZl5JkVMD05uaKoQTNDpE", authDomain: "meuappentregas.firebaseapp.com", projectId: "meuappentregas", storageBucket: "meuappentregas.firebasestorage.app", messagingSenderId: "442484186787", appId: "1:442484186787:web:ac914827ebebda987f2916" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        let dadosLoja = JSON.parse(localStorage.getItem('marcelo_loja'));
        let rascunho = [];

        window.onload = () => {
            if(!dadosLoja) document.getElementById('cadastro').classList.remove('hidden');
            else {
                document.getElementById('painel').classList.remove('hidden');
                document.getElementById('exibirNome').innerText = dadosLoja.nome;
                onSnapshot(doc(db, "config", "status"), (d) => {
                    const s = d.data() || {};
                    const el = document.getElementById('stStatus');
                    el.innerText = s.online ? (s.ocupado ? "MARCELO EM ROTA üõµ" : "MARCELO ONLINE üü¢") : "MARCELO OFFLINE üî¥";
                    el.className = `text-[9px] font-black p-2 rounded-lg italic text-white ${s.online ? 'bg-green-600' : 'bg-red-600'}`;
                });
            }
        };

        // AUTO-COMPLETAR COM TRAVA REGIONAL (Quintana e Pomp√©ia)
        window.autoCompletar = async (texto) => {
            const lista = document.getElementById('sugestoes');
            if (texto.length < 3) { lista.classList.add('hidden'); return; }

            try {
                // Coordenadas aproximadas para focar a busca na sua regi√£o
                const focoRegiao = "&viewbox=-50.35,-22.10,-50.00,-21.85&bounded=1";
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(texto)}${focoRegiao}&limit=5&countrycodes=br`);
                const data = await res.json();

                if (data.length > 0) {
                    lista.innerHTML = data.map(item => {
                        const rua = item.address.road || item.display_name.split(',')[0];
                        const bairro = item.address.suburb || item.address.neighbourhood || 'Centro';
                        const cidade = item.address.city || item.address.town || '';
                        return `
                        <div onclick="selecionarEnd('${rua}', '${bairro}', '${cidade}')" 
                             class="p-4 border-b border-gray-50 hover:bg-blue-50 cursor-pointer transition-all">
                            <p class="text-[11px] font-black text-blue-900 uppercase italic">${rua}</p>
                            <p class="text-[9px] font-bold text-gray-400 uppercase italic">${bairro} - ${cidade}</p>
                        </div>`;
                    }).join('');
                    lista.classList.remove('hidden');
                } else {
                    lista.classList.add('hidden');
                }
            } catch (e) { console.log("Erro na busca"); }
        };

        window.selecionarEnd = (rua, bairro, cidade) => {
            document.getElementById('inputEnd').value = rua + ", ";
            const selBairro = document.getElementById('bairro');
            const bUpper = bairro.toUpperCase();
            
            // Busca autom√°tica de bairro no seletor
            let achou = false;
            for (let i = 0; i < selBairro.options.length; i++) {
                if (bUpper.includes(selBairro.options[i].value)) {
                    selBairro.selectedIndex = i;
                    achou = true; break;
                }
            }
            if (!achou && cidade.toUpperCase().includes("POMP√âIA")) selBairro.value = "POMP√âIA";
            
            document.getElementById('sugestoes').classList.add('hidden');
            document.getElementById('inputEnd').focus();
        };

        // Fecha a lista se clicar fora do campo
        document.addEventListener('click', (e) => {
            if (!document.getElementById('inputEnd').contains(e.target)) {
                document.getElementById('sugestoes').classList.add('hidden');
            }
        });

        window.salvarLoja = () => {
            const n = document.getElementById('nLoja').value;
            const z = document.getElementById('zLoja').value;
            if(n && z) { localStorage.setItem('marcelo_loja', JSON.stringify({nome: n, zap: z})); location.reload(); }
        };

        window.addLista = () => {
            const rua = document.getElementById('inputEnd').value;
            const bairro = document.getElementById('bairro').value;
            const pag = document.getElementById('pagamento').value;
            const troco = document.getElementById('trocoPara').value;
            
            if(rua) {
                let infoPag = pag;
                if(pag === "DINHEIRO" && troco) infoPag += ` (Troco R$ ${troco})`;
                rascunho.push({ local: `${rua}, ${bairro}`, bairro, pag: infoPag });
                document.getElementById('inputEnd').value = '';
                document.getElementById('trocoPara').value = '';
                render();
            }
        };

        function render() {
            const listaDiv = document.getElementById('listaRascunho');
            listaDiv.innerHTML = rascunho.map((e, i) => `
                <div class="p-3 bg-gray-50 rounded-xl border-l-4 border-blue-600 flex justify-between items-center shadow-sm">
                    <div>
                        <p class="font-black text-[11px] uppercase italic">${e.local}</p>
                        <p class="text-[9px] font-black text-blue-500 italic">${e.pag}</p>
                    </div>
                    <button onclick="rascunho.splice(${i},1);render()" class="text-red-500 font-black px-3 py-1">X</button>
                </div>`).join('');
            document.getElementById('btnEnviarLote').classList.toggle('hidden', rascunho.length === 0);
        }

        window.enviarLote = async () => {
            const btn = document.getElementById('btnEnviarLote');
            btn.innerText = "ENVIANDO..."; btn.disabled = true;
            for (const item of rascunho) {
                await addDoc(collection(db, "pedidos"), {
                    loja: dadosLoja.nome, zap: dadosLoja.zap,
                    local: item.local, bairro: item.bairro,
                    pag: item.pag, status: "Fila", hora: Date.now()
                });
            }
            rascunho = []; render(); 
            btn.innerText = "ENVIAR TUDO PARA O MARCELO ‚úÖ"; btn.disabled = false;
            alert("Lote enviado com sucesso!");
        };
    </script>
</body>
</html>
