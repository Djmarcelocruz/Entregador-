<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loja - Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-4">
    <div class="max-w-md mx-auto">
        <div id="telaCadastro" class="hidden bg-white p-6 rounded-3xl shadow-xl">
            <h2 class="font-black mb-4 uppercase">Configurar Loja</h2>
            <input id="inputNome" placeholder="Nome da Loja" class="w-full p-4 mb-2 bg-gray-100 rounded-xl outline-none">
            <input id="inputZap" placeholder="WhatsApp" class="w-full p-4 mb-4 bg-gray-100 rounded-xl outline-none">
            <button onclick="salvarPerfil()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl">CONFIGURAR</button>
        </div>

        <div id="telaApp" class="hidden space-y-4">
            <div class="bg-white p-4 rounded-2xl shadow flex justify-between items-center">
                <h1 id="nomeLojaDisplay" class="font-black text-blue-900 uppercase"></h1>
                <span id="statusText" class="text-[10px] font-bold"></span>
            </div>

            <button onclick="chamar('urgente')" class="w-full bg-red-600 text-white font-black py-5 rounded-2xl shadow-lg italic">üö® SOLICITAR URGENTE</button>
            <button onclick="chamar('normal')" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl shadow-lg italic">üèçÔ∏è SOLICITAR PADR√ÉO</button>

            <div class="bg-white p-5 rounded-3xl shadow-lg">
                <input id="inputEndereco" placeholder="Endere√ßo da entrega" class="w-full p-4 bg-gray-50 rounded-xl mb-2 font-bold outline-none border-2 border-transparent focus:border-blue-500">
                <button onclick="adicionarEndereco()" class="w-full bg-gray-200 text-gray-700 font-bold py-3 rounded-xl">+ ADICIONAR NA LISTA</button>
                <div id="listaEnderecos" class="mt-4 space-y-2"></div>
                <button id="btnEnviar" onclick="enviarLote()" class="w-full bg-green-600 text-white font-black py-4 rounded-xl mt-4 hidden shadow-md">ENVIAR TUDO ‚úÖ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBjP9dxFEp09DpZl5JkVMD05uaKoQTNDpE", authDomain: "meuappentregas.firebaseapp.com", projectId: "meuappentregas", storageBucket: "meuappentregas.firebasestorage.app", messagingSenderId: "442484186787", appId: "1:442484186787:web:ac914827ebebda987f2916" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        let perfil = JSON.parse(localStorage.getItem('perfilLoja'));
        let rascunho = [];

        window.onload = () => {
            if (perfil) {
                document.getElementById('telaApp').classList.remove('hidden');
                document.getElementById('nomeLojaDisplay').textContent = perfil.nome;
                
                // Monitorar Status do Marcelo
                onSnapshot(doc(db, "sistema", "status"), (d) => {
                    const s = d.data() || {};
                    document.getElementById('statusText').innerText = s.online ? (s.ocupado ? "OCUPADO üõµ" : "ONLINE üü¢") : "OFFLINE üî¥";
                });
            } else {
                document.getElementById('telaCadastro').classList.remove('hidden');
            }
        };

        window.salvarPerfil = () => {
            const nome = document.getElementById('inputNome').value;
            const zap = document.getElementById('inputZap').value;
            if(nome && zap) {
                localStorage.setItem('perfilLoja', JSON.stringify({id: 'L'+Date.now(), nome, zap}));
                location.reload();
            }
        };

        window.chamar = async (tipo) => {
            try {
                await addDoc(collection(db, "chamados"), { 
                    tipo, loja: perfil.nome, status: "Pendente", timestamp: Date.now() 
                });
                alert("Marcelo foi chamado!");
            } catch(e) { alert("Erro ao chamar. Verifique a internet."); }
        };

        window.adicionarEndereco = () => {
            const input = document.getElementById('inputEndereco');
            if(input.value) {
                rascunho.push(input.value);
                input.value = '';
                render();
            }
        };

        function render() {
            const container = document.getElementById('listaEnderecos');
            container.innerHTML = rascunho.map((e, i) => `<div class="p-3 bg-gray-100 rounded-lg flex justify-between font-bold text-sm"><span>${e}</span><button onclick="rascunho.splice(${i},1);render()" class="text-red-500">X</button></div>`).join('');
            document.getElementById('btnEnviar').classList.toggle('hidden', rascunho.length === 0);
        }

        window.enviarLote = async () => {
            const btn = document.getElementById('btnEnviar');
            btn.innerText = "ENVIANDO..."; btn.disabled = true;
            try {
                for (const local of rascunho) {
                    await addDoc(collection(db, "pedidos"), {
                        lojaId: perfil.id, loja: perfil.nome, zap: perfil.zap,
                        local: local, status: "Fila", timestamp: Date.now(), valorEstimado: 7
                    });
                }
                rascunho = []; render(); alert("Lote entregue ao Marcelo!");
            } catch(e) { alert("Erro ao enviar. Tente novamente."); }
            btn.innerText = "ENVIAR TUDO ‚úÖ"; btn.disabled = false;
        };
    </script>
</body>
</html>
