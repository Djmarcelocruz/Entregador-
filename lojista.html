<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Marcelo Entregas - Lojista</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-4 font-sans min-h-screen">
    <div class="max-w-md mx-auto pb-20">
        
        <!-- TELA DE CADASTRO -->
        <div id="cadastro" class="hidden bg-white p-6 rounded-3xl shadow-xl">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-blue-600 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-3xl">üè™</div>
                <h2 class="text-2xl font-black text-gray-800 uppercase italic">Bem-vindo!</h2>
                <p class="text-sm text-gray-500 mt-1">Cadastro gratuito</p>
            </div>
            
            <div class="space-y-4">
                <input id="nLoja" placeholder="Nome da sua loja" autocomplete="off" class="w-full p-4 bg-gray-50 rounded-xl border-2 border-gray-200 focus:border-blue-500 outline-none font-bold text-sm">
                <input id="zLoja" placeholder="WhatsApp (somente numeros)" type="tel" maxlength="11" autocomplete="off" class="w-full p-4 bg-gray-50 rounded-xl border-2 border-gray-200 focus:border-blue-500 outline-none font-bold text-sm">
                <input id="eLoja" placeholder="Endereco completo da loja" autocomplete="off" class="w-full p-4 bg-gray-50 rounded-xl border-2 border-gray-200 focus:border-blue-500 outline-none font-bold text-sm">
                <button onclick="salvarLoja()" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-xl font-black uppercase italic shadow-lg transform active:scale-95 transition-all">
                    Comecar a Usar
                </button>
            </div>
        </div>

        <!-- PAINEL PRINCIPAL -->
        <div id="painel" class="hidden space-y-4">
            
            <!-- HEADER -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-4 rounded-2xl shadow-lg text-white">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-[10px] opacity-80 uppercase italic">Sua Loja</p>
                        <h1 id="exibirNome" class="text-lg font-black uppercase italic"></h1>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] opacity-80 uppercase italic">Marcelo</p>
                        <span id="stStatus" class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-white/20 text-[10px] font-black">
                            <span class="w-2 h-2 rounded-full bg-gray-300"></span>
                            Verificando...
                        </span>
                    </div>
                </div>
            </div>

            <!-- BOTAO CHAMAR -->
            <button id="btnChamada" onclick="chamarMarcelo()" class="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white p-5 rounded-2xl font-black shadow-xl uppercase italic transform active:scale-95 transition-all disabled:opacity-50">
                <span id="txtChamada" class="flex items-center justify-center gap-2 text-lg">
                    <span>üîî</span>
                    <span>Chamar Marcelo Agora</span>
                </span>
            </button>
            <p id="msgChamada" class="text-center text-sm font-bold hidden"></p>

            <!-- FORMULARIO ENTREGA -->
            <div class="bg-white p-5 rounded-2xl shadow-lg">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">üì¶</span>
                    <h2 class="font-black text-gray-800 uppercase italic">Nova Entrega</h2>
                </div>

                <div class="space-y-3">
                    <input id="inputEnd" placeholder="Rua e numero" autocomplete="off" class="w-full p-4 bg-blue-50 rounded-xl font-bold text-sm border-2 border-transparent focus:border-blue-400 outline-none">
                    <input id="inputRef" placeholder="Ponto de referencia (opcional)" autocomplete="off" class="w-full p-4 bg-gray-50 rounded-xl font-bold text-sm border-2 border-transparent focus:border-blue-400 outline-none">
                    
                    <div class="grid grid-cols-2 gap-3">
                        <select id="pagamento" autocomplete="off" class="p-4 bg-gray-50 rounded-xl font-bold text-xs uppercase italic border-2 border-transparent focus:border-blue-400 outline-none">
                            <option value="JA PAGO">J√° Pago</option>
                            <option value="DINHEIRO">Dinheiro</option>
                            <option value="PIX">PIX</option>
                            <option value="CARTAO">Cart√£o</option>
                        </select>
                        <input id="trocoPara" type="number" placeholder="Troco para quanto?" autocomplete="off" class="hidden p-4 bg-gray-50 rounded-xl font-bold text-sm border-2 border-transparent focus:border-blue-400 outline-none">
                    </div>

                    <textarea id="obsEntrega" placeholder="Observacoes (ex: portao azul, cuidado com cachorro)" rows="2" autocomplete="off" class="w-full p-4 bg-yellow-50 rounded-xl font-bold text-sm border-2 border-transparent focus:border-yellow-400 outline-none resize-none"></textarea>

                    <button onclick="addLista()" class="w-full bg-slate-800 hover:bg-slate-900 text-white p-4 rounded-xl font-black uppercase italic shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-2">
                        <span class="text-xl">+</span>
                        <span>Adicionar √† Lista</span>
                    </button>
                </div>

                <!-- LISTA RASCUNHO -->
                <div id="listaRascunho" class="space-y-2 mt-4 max-h-64 overflow-y-auto"></div>
                
                <!-- BOTAO ENVIAR -->
                <button id="btnEnviar" onclick="enviarTudo()" class="hidden w-full bg-green-600 hover:bg-green-700 text-white p-4 rounded-xl font-black shadow-xl uppercase italic mt-4 transform active:scale-95 transition-all">
                    Enviar <span id="contadorEnvio">0</span> Entrega(s)
                </button>
            </div>

            <!-- STATUS ENTREGAS -->
            <div class="bg-white p-4 rounded-2xl shadow-lg">
                <h3 class="font-black text-gray-800 uppercase italic text-sm mb-3 flex items-center gap-2">
                    <span>üìã</span> Suas Entregas Hoje
                </h3>
                <div id="minhasEntregas" class="space-y-2 text-sm">
                    <p class="text-center text-gray-400 text-xs py-4">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, Timestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBjP9dxFEp09DpZl5JkVMD05uaKoQTNDpE", 
            authDomain: "meuappentregas.firebaseapp.com", 
            projectId: "meuappentregas", 
            storageBucket: "meuappentregas.firebasestorage.app", 
            messagingSenderId: "442484186787", 
            appId: "1:442484186787:web:ac914827ebebda987f2916" 
        };
        
        let app;
        let db;
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log('Firebase inicializado com sucesso');
        } catch (e) {
            console.error('Erro ao inicializar Firebase:', e);
            alert('Erro ao conectar ao Firebase. Verifique sua conex√£o.');
        }
        
        let dadosLoja = JSON.parse(localStorage.getItem('marcelo_loja'));
        let rascunho = [];

        // MOSTRAR/ESCONDER CAMPO TROCO
        document.getElementById('pagamento')?.addEventListener('change', function() {
            const mostrar = ['DINHEIRO', 'PIX'].includes(this.value);
            document.getElementById('trocoPara').classList.toggle('hidden', !mostrar);
        });

        // INICIALIZAR
        function iniciar() {
            // Verificar se dadosLoja tem todos os campos necess√°rios
            if (dadosLoja) {
                if (!dadosLoja.endereco || !dadosLoja.nome || !dadosLoja.zap) {
                    console.log('Dados incompletos, refazendo cadastro');
                    localStorage.removeItem('marcelo_loja');
                    dadosLoja = null;
                }
            }

            if (!dadosLoja) {
                document.getElementById('cadastro').classList.remove('hidden');
            } else {
                mostrarPainel();
            }
        }

        function mostrarPainel() {
            document.getElementById('painel').classList.remove('hidden');
            document.getElementById('exibirNome').textContent = dadosLoja.nome;
            
            // MONITORAR STATUS MARCELO
            try {
                onSnapshot(doc(db, 'config', 'status'), (docSnap) => {
                    const s = docSnap.data() || { online: false, ocupado: false };
                    const el = document.getElementById('stStatus');
                    const btn = document.getElementById('btnChamada');
                    
                    if (s.online && !s.ocupado) {
                        el.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-400"></span> Disponivel';
                        el.className = 'inline-flex items-center gap-1 px-3 py-1 rounded-full bg-green-500 text-[10px] font-black text-white';
                        btn.disabled = false;
                    } else if (s.ocupado) {
                        el.innerHTML = '<span class="w-2 h-2 rounded-full bg-orange-400"></span> Em Entrega';
                        el.className = 'inline-flex items-center gap-1 px-3 py-1 rounded-full bg-orange-500 text-[10px] font-black text-white';
                        btn.disabled = true;
                    } else {
                        el.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-400"></span> Indisponivel';
                        el.className = 'inline-flex items-center gap-1 px-3 py-1 rounded-full bg-red-500 text-[10px] font-black text-white';
                        btn.disabled = true;
                    }
                }, (error) => {
                    console.error('Erro ao ouvir status:', error);
                    document.getElementById('stStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-red-400"></span> Erro';
                });
            } catch (e) {
                console.error('Erro ao configurar listener de status:', e);
            }

            // CARREGAR ENTREGAS
            carregarEntregas();
            setInterval(carregarEntregas, 10000);
        }

        async function carregarEntregas() {
            const div = document.getElementById('minhasEntregas');
            
            try {
                const snapshot = await getDocs(collection(db, 'pedidos'));
                const entregas = [];
                
                snapshot.forEach((doc) => {
                    const p = doc.data();
                    if (p.loja === dadosLoja.nome && p.status !== 'Concluido') {
                        entregas.push({ id: doc.id, ...p });
                    }
                });

                entregas.sort((a, b) => {
                    const timeA = a.hora?.seconds || 0;
                    const timeB = b.hora?.seconds || 0;
                    return timeB - timeA;
                });

                div.innerHTML = '';
                
                if (entregas.length === 0) {
                    div.innerHTML = '<p class="text-center text-gray-400 text-xs py-4">Nenhuma entrega ativa</p>';
                    return;
                }

                entregas.forEach((p) => {
                    const statusConfig = {
                        'Ativo': { texto: '‚è≥ Aguardando', cor: 'border-blue-500 bg-blue-50' },
                        'SaiuParaEntrega': { texto: 'üõµ A caminho', cor: 'border-orange-500 bg-orange-50' },
                        'Chegou': { texto: '‚úÖ Entregue', cor: 'border-green-500 bg-green-50' }
                    };
                    
                    const config = statusConfig[p.status] || statusConfig['Ativo'];
                    
                    div.innerHTML += `
                        <div class="p-3 ${config.cor} rounded-xl border-l-4 mb-2">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="font-bold text-gray-800 text-xs truncate">${p.local}</p>
                                    <p class="text-[10px] text-gray-500">${p.pag}</p>
                                </div>
                                <span class="text-[10px] font-black">${config.texto}</span>
                            </div>
                            ${p.obs ? `<p class="text-[10px] text-gray-400 mt-1 italic">"${p.obs}"</p>` : ''}
                        </div>
                    `;
                });
            } catch (error) {
                console.error('Erro ao carregar entregas:', error);
                div.innerHTML = `<p class="text-center text-red-400 text-xs py-4">Erro: ${error.message}</p>`;
            }
        }

        // CHAMAR MARCELO - COM VERIFICA√á√ÉO DE ENDERE√áO
        window.chamarMarcelo = async function() {
            const btn = document.getElementById('btnChamada');
            const txt = document.getElementById('txtChamada');
            const msg = document.getElementById('msgChamada');
            
            // VERIFICAR SE TEM ENDERE√áO
            if (!dadosLoja.endereco) {
                alert('Erro: Endere√ßo da loja n√£o encontrado. Por favor, refa√ßa seu cadastro.');
                localStorage.removeItem('marcelo_loja');
                location.reload();
                return;
            }
            
            btn.disabled = true;
            txt.innerHTML = '<span>Chamando...</span>';
            
            try {
                await addDoc(collection(db, 'chamadas'), {
                    loja: dadosLoja.nome,
                    zap: dadosLoja.zap,
                    enderecoLoja: dadosLoja.endereco || 'Endere√ßo n√£o informado', // FALLBACK
                    hora: Timestamp.now(),
                    status: 'Pendente'
                });
                
                txt.innerHTML = '<span>‚úÖ Marcelo foi avisado!</span>';
                btn.classList.remove('from-orange-500', 'to-red-500');
                btn.classList.add('bg-green-600');
                msg.textContent = 'Aguarde, ele confirmara em breve.';
                msg.className = 'text-center text-sm font-bold text-green-600 mt-2';
                msg.classList.remove('hidden');
                
                setTimeout(() => {
                    btn.disabled = false;
                    txt.innerHTML = '<span>üîî</span><span>Chamar Marcelo Agora</span>';
                    btn.classList.add('from-orange-500', 'to-red-500');
                    btn.classList.remove('bg-green-600');
                    msg.classList.add('hidden');
                }, 10000);
                
            } catch (e) {
                console.error('Erro ao chamar:', e);
                alert('Erro ao chamar: ' + e.message);
                btn.disabled = false;
                txt.innerHTML = '<span>üîî</span><span>Chamar Marcelo Agora</span>';
            }
        };

        // ADICIONAR √Ä LISTA
        window.addLista = function() {
            const rua = document.getElementById('inputEnd').value.trim();
            const ref = document.getElementById('inputRef').value.trim();
            const pag = document.getElementById('pagamento').value;
            const troco = document.getElementById('trocoPara').value;
            const obs = document.getElementById('obsEntrega').value.trim();
            
            if (!rua) {
                alert('Informe o endereco');
                return;
            }
            
            let infoPag = pag;
            if (troco && ['DINHEIRO', 'PIX'].includes(pag)) {
                infoPag += ` (Troco: R$${parseFloat(troco).toFixed(2)})`;
            }
            
            rascunho.push({
                id: Date.now(),
                local: rua,
                referencia: ref,
                pag: infoPag,
                obs: obs
            });
            
            document.getElementById('inputEnd').value = '';
            document.getElementById('inputRef').value = '';
            document.getElementById('trocoPara').value = '';
            document.getElementById('obsEntrega').value = '';
            document.getElementById('inputEnd').focus();
            
            renderRascunho();
        };

        function renderRascunho() {
            const div = document.getElementById('listaRascunho');
            div.innerHTML = rascunho.map((item, i) => `
                <div class="p-3 bg-blue-50 rounded-xl border-l-4 border-blue-600 flex justify-between items-start">
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-sm text-gray-800">${item.local}</p>
                        ${item.referencia ? `<p class="text-xs text-gray-500">üìç ${item.referencia}</p>` : ''}
                        <p class="text-xs font-bold text-blue-600 mt-1">${item.pag}</p>
                        ${item.obs ? `<p class="text-[10px] text-gray-400 mt-1 italic">"${item.obs}"</p>` : ''}
                    </div>
                    <button onclick="removerItem(${i})" class="ml-2 text-red-500 font-black text-lg hover:bg-red-50 w-8 h-8 rounded-lg flex items-center justify-center">
                        √ó
                    </button>
                </div>
            `).join('');
            
            const btn = document.getElementById('btnEnviar');
            const contador = document.getElementById('contadorEnvio');
            
            if (rascunho.length > 0) {
                btn.classList.remove('hidden');
                contador.textContent = rascunho.length;
            } else {
                btn.classList.add('hidden');
            }
        }

        window.removerItem = function(i) {
            rascunho.splice(i, 1);
            renderRascunho();
        };

        // ENVIAR TUDO
        window.enviarTudo = async function() {
            const btn = document.getElementById('btnEnviar');
            btn.innerHTML = 'Enviando...';
            btn.disabled = true;
            
            try {
                for (const item of rascunho) {
                    await addDoc(collection(db, 'pedidos'), {
                        loja: dadosLoja.nome,
                        zap: dadosLoja.zap,
                        local: item.local,
                        referencia: item.referencia,
                        pag: item.pag,
                        obs: item.obs,
                        status: 'Ativo',
                        hora: Timestamp.now()
                    });
                }
                
                rascunho = [];
                renderRascunho();
                btn.innerHTML = '‚úÖ Enviado com Sucesso!';
                
                setTimeout(() => {
                    btn.classList.add('hidden');
                    btn.disabled = false;
                    btn.innerHTML = 'Enviar <span id="contadorEnvio">0</span> Entrega(s)';
                }, 2000);
                
            } catch (e) {
                console.error('Erro ao enviar:', e);
                alert('Erro ao enviar: ' + e.message);
                btn.disabled = false;
                btn.innerHTML = 'Enviar <span id="contadorEnvio">' + rascunho.length + '</span> Entrega(s)';
            }
        };

        // SALVAR LOJA
        window.salvarLoja = function() {
            const n = document.getElementById('nLoja').value.trim();
            const z = document.getElementById('zLoja').value.trim();
            const e = document.getElementById('eLoja').value.trim();
            
            if (!n || !z || !e) {
                alert('Preencha todos os campos');
                return;
            }
            
            if (z.length !== 11) {
                alert('WhatsApp invalido. Use DDD + numero (11 digitos)');
                return;
            }
            
            localStorage.setItem('marcelo_loja', JSON.stringify({ nome: n, zap: z, endereco: e }));
            location.reload();
        };

        // INICIAR
        iniciar();
    </script>
</body>
</html>
