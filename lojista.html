<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lojista - Quintana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyBjP9dxFEp09DpZl5JkVMD05uaKoQTNDpE", authDomain: "meuappentregas.firebaseapp.com", projectId: "meuappentregas", storageBucket: "meuappentregas.firebasestorage.app", messagingSenderId: "442484186787", appId: "1:442484186787:web:ac914827ebebda987f2916" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);
        const perfil = JSON.parse(localStorage.getItem('perfilLoja'));

        window.chamarPresenca = async () => {
            await addDoc(collection(db, "chamados"), { loja: perfil.nome, status: "Pendente", tempo: "", timestamp: Date.now() });
        };

        window.responderChamado = async (id, acao) => {
            if(acao === 'OK') await updateDoc(doc(db, "chamados", id), { status: "Confirmado" });
            else await deleteDoc(doc(db, "chamados", id));
        };

        window.onload = () => {
            if(!perfil) return document.getElementById('reg').classList.remove('hidden');
            document.getElementById('app').classList.remove('hidden');
            onSnapshot(query(collection(db, "chamados"), where("loja", "==", perfil.nome)), (snaps) => {
                const div = document.getElementById('statusChamado'); div.innerHTML = "";
                snaps.forEach(d => {
                    const c = d.data();
                    if(c.status === "Respondido") {
                        div.innerHTML = `<div class="bg-blue-100 p-4 rounded-2xl border-2 border-blue-500 text-center">
                            <p class="font-bold">Marcelo chega em ${c.tempo}?</p>
                            <div class="flex gap-2 mt-2">
                                <button onclick="responderChamado('${d.id}', 'OK')" class="flex-1 bg-green-500 text-white font-bold py-2 rounded-xl">SIM, PODE VIR</button>
                                <button onclick="responderChamado('${d.id}', 'NAO')" class="flex-1 bg-red-500 text-white font-bold py-2 rounded-xl">AGORA NÃƒO</button>
                            </div>
                        </div>`;
                    } else if(c.status === "Confirmado") {
                        div.innerHTML = `<div class="bg-green-500 text-white p-4 rounded-2xl font-bold text-center italic animate-pulse">MARCELO A CAMINHO!</div>`;
                    } else {
                        div.innerHTML = `<div class="bg-gray-100 p-4 rounded-2xl text-center text-gray-500 font-bold">Chamada enviada...</div>`;
                    }
                });
            });
        };

        window.salvarPerfil = () => {
            localStorage.setItem('perfilLoja', JSON.stringify({ nome: document.getElementById('n').value, zap: document.getElementById('z').value }));
            location.reload();
        };
    </script>
</head>
<body class="bg-slate-50 p-4 font-sans">
    <div id="reg" class="max-w-md mx-auto bg-white p-8 rounded-3xl hidden shadow-xl text-center">
        <input id="n" placeholder="Nome da Loja" class="w-full p-4 mb-4 bg-gray-50 rounded-2xl border">
        <button onclick="salvarPerfil()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl">ENTRAR</button>
    </div>
    <div id="app" class="max-w-md mx-auto hidden space-y-4">
        <button onclick="chamarPresenca()" class="w-full bg-blue-600 text-white font-black py-6 rounded-3xl shadow-xl text-xl uppercase italic">SOLICITAR MOTOBOY ðŸ›µ</button>
        <div id="statusChamado"></div>
    </div>
</body>
</html>
