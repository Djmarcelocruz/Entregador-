<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <title>Loja Pro - Gest√£o de Entregas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTG9qYSBQcm8iLCJzaG9ydF9uYW1lIjoiTG9qYSIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjMjU2M2ViIn0=">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slight': 'bounceSlight 0.3s ease-in-out'
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        bounceSlight: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.05)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .dark .glass { background: rgba(30, 41, 59, 0.9); }
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900 transition-colors duration-300">
    <div id="app-container" class="max-w-lg mx-auto min-h-screen relative">
        
        <!-- Splash Screen -->
        <div id="splash" class="fixed inset-0 bg-blue-600 z-50 flex items-center justify-center transition-opacity duration-500">
            <div class="text-center text-white">
                <div class="text-6xl mb-4 animate-bounce">üè™</div>
                <h1 class="text-2xl font-black">LOJA PRO</h1>
                <p class="text-blue-200 mt-2">Sistema de Entregas</p>
            </div>
        </div>

        <!-- Tela de Cadastro -->
        <div id="cad" class="hidden min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-white dark:bg-slate-800 rounded-3xl shadow-2xl p-8 animate-slide-up">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl">üè™</div>
                    <h2 class="text-2xl font-black text-gray-800 dark:text-white">Bem-vindo!</h2>
                    <p class="text-gray-500 dark:text-gray-400 mt-2">Configure sua loja para come√ßar</p>
                </div>

                <form id="cadForm" class="space-y-4">
                    <div class="relative">
                        <input type="text" id="n" required minlength="3" maxlength="50"
                            class="w-full p-4 bg-gray-50 dark:bg-slate-700 border-2 border-transparent rounded-xl focus:border-blue-500 outline-none transition dark:text-white peer"
                            placeholder=" ">
                        <label class="absolute left-4 top-4 text-gray-400 transition-all peer-focus:-top-2 peer-focus:text-xs peer-focus:text-blue-500 peer-focus:bg-white peer-focus:px-2 peer-not-placeholder-shown:-top-2 peer-not-placeholder-shown:text-xs peer-not-placeholder-shown:bg-white peer-not-placeholder-shown:px-2 dark:peer-focus:bg-slate-800 dark:peer-not-placeholder-shown:bg-slate-800">Nome da Loja</label>
                    </div>

                    <div class="relative">
                        <input type="tel" id="z" required minlength="10" maxlength="15"
                            class="w-full p-4 bg-gray-50 dark:bg-slate-700 border-2 border-transparent rounded-xl focus:border-blue-500 outline-none transition dark:text-white peer"
                            placeholder=" ">
                        <label class="absolute left-4 top-4 text-gray-400 transition-all peer-focus:-top-2 peer-focus:text-xs peer-focus:text-blue-500 peer-focus:bg-white peer-focus:px-2 peer-not-placeholder-shown:-top-2 peer-not-placeholder-shown:text-xs peer-not-placeholder-shown:bg-white peer-not-placeholder-shown:px-2 dark:peer-focus:bg-slate-800 dark:peer-not-placeholder-shown:bg-slate-800">WhatsApp (com DDD)</label>
                    </div>

                    <div class="relative">
                        <input type="text" id="enderecoLoja"
                            class="w-full p-4 bg-gray-50 dark:bg-slate-700 border-2 border-transparent rounded-xl focus:border-blue-500 outline-none transition dark:text-white peer"
                            placeholder=" ">
                        <label class="absolute left-4 top-4 text-gray-400 transition-all peer-focus:-top-2 peer-focus:text-xs peer-focus:text-blue-500 peer-focus:bg-white peer-focus:px-2 peer-not-placeholder-shown:-top-2 peer-not-placeholder-shown:text-xs peer-not-placeholder-shown:bg-white peer-not-placeholder-shown:px-2 dark:peer-focus:bg-slate-800 dark:peer-not-placeholder-shown:bg-slate-800">Endere√ßo da Loja (opcional)</label>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition transform active:scale-95 flex items-center justify-center gap-2">
                        <span>CONTINUAR</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                    </button>
                </form>
            </div>
        </div>

        <!-- App Principal -->
        <div id="app" class="hidden pb-24">
            <!-- Header Flutuante -->
            <header class="sticky top-0 z-40 glass border-b dark:border-slate-700 px-4 py-3">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-lg" id="avatarLoja">L</div>
                        <div>
                            <h1 id="nLoja" class="font-black text-gray-800 dark:text-white leading-tight"></h1>
                            <div class="flex items-center gap-1">
                                <span id="statusIndicator" class="w-2 h-2 rounded-full bg-gray-400"></span>
                                <span id="st" class="text-xs text-gray-500 dark:text-gray-400 font-medium">Verificando...</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 transition">
                        <span id="themeIcon">üåô</span>
                    </button>
                </div>
            </header>

            <!-- Conte√∫do -->
            <main class="p-4 space-y-4">
                <!-- Bot√£o Emerg√™ncia -->
                <button onclick="chamarMoto('urgente')" class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-4 rounded-2xl shadow-lg transform transition hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2 animate-pulse-slow">
                    <span class="text-2xl">üö®</span>
                    <div class="text-left">
                        <div class="text-sm opacity-90">PRECISO AGORA</div>
                        <div class="text-xs opacity-75">Entrega urgente</div>
                    </div>
                </button>

                <!-- Bot√£o Normal -->
                <button onclick="chamarMoto('normal')" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-4 rounded-2xl shadow-lg transform transition hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2">
                    <span class="text-2xl">üèçÔ∏è</span>
                    <div class="text-left">
                        <div class="text-sm opacity-90">SOLICITAR ENTREGADOR</div>
                        <div class="text-xs opacity-75">Entrega padr√£o</div>
                    </div>
                </button>

                <!-- Card de Lote -->
                <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-lg overflow-hidden">
                    <div class="p-4 border-b dark:border-slate-700 flex justify-between items-center">
                        <h3 class="font-bold text-gray-700 dark:text-gray-200 flex items-center gap-2">
                            <span>üì¶</span> Lote de Entregas
                        </h3>
                        <span id="contador" class="bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 px-3 py-1 rounded-full text-xs font-bold">0 itens</span>
                    </div>

                    <div class="p-4">
                        <div class="flex gap-2 mb-4">
                            <div class="relative flex-1">
                                <input type="text" id="end" placeholder="Endere√ßo de entrega..." 
                                    class="w-full p-3 pr-10 bg-gray-50 dark:bg-slate-700 rounded-xl border-2 border-transparent focus:border-blue-500 outline-none transition dark:text-white text-sm"
                                    onkeypress="handleEnter(event)">
                                <button onclick="getLocation()" class="absolute right-2 top-1/2 -translate-y-1/2 p-1 text-gray-400 hover:text-blue-500 transition" title="Usar localiza√ß√£o atual">
                                    üìç
                                </button>
                            </div>
                            <button onclick="addLista()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded-xl font-bold transition active:scale-95">
                                +
                            </button>
                        </div>

                        <!-- Lista -->
                        <div id="lista" class="space-y-2 min-h-[100px] max-h-[400px] overflow-y-auto">
                            <div class="text-center py-8 text-gray-400 dark:text-gray-500">
                                <div class="text-4xl mb-2">üìù</div>
                                <p class="text-sm">Adicione endere√ßos para criar um lote</p>
                            </div>
                        </div>

                        <!-- Resumo -->
                        <div id="resumoLote" class="hidden mt-4 pt-4 border-t dark:border-slate-700">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-sm text-gray-500 dark:text-gray-400">Total estimado:</span>
                                <span class="font-black text-lg text-blue-600 dark:text-blue-400" id="valorEstimado">R$ 0,00</span>
                            </div>
                            <button onclick="enviarTudo()" id="btnEnviar" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl transition transform active:scale-95 flex items-center justify-center gap-2">
                                <span>ENVIAR LOTE</span>
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Hist√≥rico Recente -->
                <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-lg p-4">
                    <h3 class="font-bold text-gray-700 dark:text-gray-200 mb-3 flex items-center gap-2">
                        <span>üìú</span> Hist√≥rico Recente
                    </h3>
                    <div id="historico" class="space-y-2">
                        <p class="text-sm text-gray-400 text-center py-4">Nenhuma entrega recente</p>
                    </div>
                </div>
            </main>
        </div>

        <!-- Toast Container -->
        <div id="toastContainer" class="fixed bottom-4 left-4 right-4 z-50 flex flex-col gap-2 pointer-events-none"></div>
    </div>

    <script type="module">
        // ===== CONFIGURA√á√ÉO =====
        const firebaseConfig = {
            apiKey: "AIzaSyBjP9dxFEp09DpZl5JkVMD05uaKoQTNDpE",
            authDomain: "meuappentregas.firebaseapp.com",
            projectId: "meuappentregas",
            storageBucket: "meuappentregas.firebasestorage.app",
            messagingSenderId: "442484186787",
            appId: "1:442484186787:web:ac914827ebebda987f2916"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, doc, 
            serverTimestamp, enableIndexedDbPersistence, query, 
            where, orderBy, limit 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Enable offline persistence
        enableIndexedDbPersistence(db).catch(err => {
            if (err.code == 'failed-precondition') {
                console.warn('Multiple tabs open, persistence can only be enabled in one tab at a time.');
            }
        });

        // ===== ESTADO =====
        const Store = {
            perfil: null,
            rascunho: [],
            historico: [],
            config: { taxaPadrao: 7.00, taxaUrgente: 12.00 },
            isOnline: navigator.onLine,
            processing: false
        };

        // ===== UTILIT√ÅRIOS =====
        const utils = {
            sanitize: (str) => {
                const div = document.createElement('div');
                div.textContent = String(str);
                return div.innerHTML;
            },
            
            formatCurrency: (val) => {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(val);
            },
            
            formatDate: (timestamp) => {
                if (!timestamp) return '';
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleString('pt-BR', { 
                    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
                });
            },
            
            generateId: () => `_${Date.now().toString(36)}${Math.random().toString(36).substr(2, 9)}`,
            
            debounce: (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            playSound: (type) => {
                const audio = new Audio();
                audio.src = type === 'success' 
                    ? 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE'
                    : 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=';
                audio.volume = 0.3;
                audio.play().catch(() => {});
            }
        };

        // ===== UI COMPONENTS =====
        const ui = {
            toast: (message, type = 'success', duration = 3000) => {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-orange-500',
                    info: 'bg-blue-500'
                };
                const icons = {
                    success: '‚úì',
                    error: '‚úï',
                    warning: '‚ö†',
                    info: '‚Ñπ'
                };
                
                toast.className = `${colors[type]} text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 transform transition-all duration-300 translate-y-10 opacity-0 pointer-events-auto`;
                toast.innerHTML = `
                    <span class="font-bold text-lg">${icons[type]}</span>
                    <span class="font-medium text-sm">${message}</span>
                `;
                
                container.appendChild(toast);
                
                requestAnimationFrame(() => {
                    toast.classList.remove('translate-y-10', 'opacity-0');
                });
                
                setTimeout(() => {
                    toast.classList.add('translate-y-10', 'opacity-0');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            },
            
            setLoading: (element, loading, text = null) => {
                if (loading) {
                    element.dataset.originalHTML = element.innerHTML;
                    element.innerHTML = `<div class="animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full"></div>`;
                    element.disabled = true;
                } else {
                    element.innerHTML = text || element.dataset.originalHTML;
                    element.disabled = false;
                }
            },
            
            updateTheme: () => {
                const isDark = localStorage.getItem('theme') === 'dark';
                document.documentElement.classList.toggle('dark', isDark);
                document.getElementById('themeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            }
        };

        // ===== SERVI√áOS =====
        const services = {
            savePerfil: (perfil) => {
                localStorage.setItem('lojaPerfil', JSON.stringify(perfil));
                Store.perfil = perfil;
            },
            
            loadPerfil: () => {
                try {
                    const data = localStorage.getItem('lojaPerfil');
                    if (data) {
                        Store.perfil = JSON.parse(data);
                        return true;
                    }
                } catch (e) {
                    console.error('Erro ao carregar perfil:', e);
                }
                return false;
            },
            
            saveRascunho: () => {
                localStorage.setItem('lojaRascunho', JSON.stringify(Store.rascunho));
            },
            
            loadRascunho: () => {
                try {
                    const data = localStorage.getItem('lojaRascunho');
                    if (data) Store.rascunho = JSON.parse(data);
                } catch (e) {
                    console.error('Erro ao carregar rascunho:', e);
                }
            },
            
            addToQueue: async (collectionName, data) => {
                // Se offline, salva na fila local
                if (!Store.isOnline) {
                    const queue = JSON.parse(localStorage.getItem('syncQueue') || '[]');
                    queue.push({ collection: collectionName, data, timestamp: Date.now() });
                    localStorage.setItem('syncQueue', JSON.stringify(queue));
                    return { id: 'pending_' + Date.now(), offline: true };
                }
                
                return await addDoc(collection(db, collectionName), {
                    ...data,
                    timestamp: serverTimestamp(),
                    createdAt: new Date().toISOString()
                });
            },
            
            syncOfflineData: async () => {
                const queue = JSON.parse(localStorage.getItem('syncQueue') || '[]');
                if (queue.length === 0) return;
                
                ui.toast(`Sincronizando ${queue.length} item(s)...`, 'info');
                
                for (const item of queue) {
                    try {
                        await addDoc(collection(db, item.collection), {
                            ...item.data,
                            timestamp: serverTimestamp(),
                            syncedAt: new Date().toISOString()
                        });
                    } catch (e) {
                        console.error('Erro ao sincronizar:', e);
                    }
                }
                
                localStorage.removeItem('syncQueue');
                ui.toast('Sincroniza√ß√£o conclu√≠da!', 'success');
            }
        };

        // ===== CONTROLLERS =====
        const controllers = {
            init: () => {
                // Verificar tema
                ui.updateTheme();
                
                // Verificar conex√£o
                window.addEventListener('online', () => {
                    Store.isOnline = true;
                    ui.toast('Conex√£o restaurada', 'success');
                    services.syncOfflineData();
                });
                
                window.addEventListener('offline', () => {
                    Store.isOnline = false;
                    ui.toast('Modo offline ativado', 'warning');
                });
                
                // Carregar dados
                services.loadRascunho();
                
                if (services.loadPerfil()) {
                    controllers.showApp();
                } else {
                    document.getElementById('splash').classList.add('opacity-0');
                    setTimeout(() => {
                        document.getElementById('splash').classList.add('hidden');
                        document.getElementById('cad').classList.remove('hidden');
                    }, 500);
                }
                
                // Setup listeners
                document.getElementById('cadForm').addEventListener('submit', controllers.cadastrar);
            },
            
            cadastrar: (e) => {
                e.preventDefault();
                
                const nome = document.getElementById('n').value.trim();
                const zap = document.getElementById('z').value.replace(/\D/g, '');
                const endereco = document.getElementById('enderecoLoja').value.trim();
                
                if (zap.length < 10) {
                    ui.toast('WhatsApp inv√°lido', 'error');
                    return;
                }
                
                const perfil = {
                    id: utils.generateId(),
                    nome,
                    zap,
                    endereco,
                    createdAt: new Date().toISOString()
                };
                
                services.savePerfil(perfil);
                ui.toast('Perfil salvo com sucesso!');
                
                document.getElementById('cad').classList.add('hidden');
                controllers.showApp();
            },
            
            showApp: () => {
                document.getElementById('splash').classList.add('opacity-0');
                setTimeout(() => {
                    document.getElementById('splash').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    document.getElementById('app').classList.add('animate-slide-up');
                    
                    // Preencher dados
                    document.getElementById('nLoja').textContent = Store.perfil.nome;
                    document.getElementById('avatarLoja').textContent = Store.perfil.nome.charAt(0).toUpperCase();
                    
                    controllers.renderRascunho();
                    controllers.setupRealtime();
                    controllers.loadHistorico();
                }, 500);
            },
            
            setupRealtime: () => {
                // Monitorar status do entregador
                onSnapshot(doc(db, "config", "status"), (doc) => {
                    const data = doc.data() || {};
                    const indicator = document.getElementById('statusIndicator');
                    const text = document.getElementById('st');
                    
                    if (data.ocupado) {
                        indicator.className = 'w-2 h-2 rounded-full bg-orange-500 animate-pulse';
                        text.textContent = 'Entregador em rota';
                    } else if (data.online) {
                        indicator.className = 'w-2 h-2 rounded-full bg-green-500';
                        text.textContent = 'Entregador online';
                    } else {
                        indicator.className = 'w-2 h-2 rounded-full bg-red-500';
                        text.textContent = 'Entregador offline';
                    }
                }, (error) => {
                    console.error('Erro no realtime:', error);
                });
            },
            
            loadHistorico: () => {
                const q = query(
                    collection(db, "pedidos"),
                    where("lojaId", "==", Store.perfil.id),
                    orderBy("timestamp", "desc"),
                    limit(5)
                );
                
                onSnapshot(q, (snapshot) => {
                    const container = document.getElementById('historico');
                    
                    if (snapshot.empty) {
                        container.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">Nenhuma entrega recente</p>';
                        return;
                    }
                    
                    container.innerHTML = '';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center p-3 bg-gray-50 dark:bg-slate-700 rounded-xl text-sm';
                        div.innerHTML = `
                            <div class="flex-1 min-w-0 mr-2">
                                <p class="font-medium text-gray-700 dark:text-gray-200 truncate">${utils.sanitize(data.local)}</p>
                                <p class="text-xs text-gray-400">${utils.formatDate(data.timestamp)}</p>
                            </div>
                            <span class="px-2 py-1 rounded-lg text-xs font-bold ${
                                data.status === 'Entregue' ? 'bg-green-100 text-green-600' : 
                                data.status === 'Em rota' ? 'bg-blue-100 text-blue-600' : 
                                'bg-gray-100 text-gray-600'
                            }">${data.status}</span>
                        `;
                        container.appendChild(div);
                    });
                });
            },
            
            renderRascunho: () => {
                const lista = document.getElementById('lista');
                const contador = document.getElementById('contador');
                const resumo = document.getElementById('resumoLote');
                const valorEstimado = document.getElementById('valorEstimado');
                
                contador.textContent = `${Store.rascunho.length} item${Store.rascunho.length !== 1 ? 's' : ''}`;
                
                if (Store.rascunho.length === 0) {
                    lista.innerHTML = `
                        <div class="text-center py-8 text-gray-400 dark:text-gray-500">
                            <div class="text-4xl mb-2">üìù</div>
                            <p class="text-sm">Adicione endere√ßos para criar um lote</p>
                        </div>
                    `;
                    resumo.classList.add('hidden');
                    return;
                }
                
                lista.innerHTML = '';
                let totalEstimado = 0;
                
                Store.rascunho.forEach((item, index) => {
                    const valor = item.tipo === 'urgente' ? Store.config.taxaUrgente : Store.config.taxaPadrao;
                    totalEstimado += valor;
                    
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3 p-3 bg-gray-50 dark:bg-slate-700 rounded-xl group animate-slide-up';
                    div.style.animationDelay = `${index * 50}ms`;
                    div.innerHTML = `
                        <div class="w-8 h-8 rounded-full ${item.tipo === 'urgente' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'} flex items-center justify-center text-xs font-bold flex-shrink-0">
                            ${index + 1}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-gray-700 dark:text-gray-200 text-sm truncate">${utils.sanitize(item.endereco)}</p>
                            <p class="text-xs text-gray-400">${item.tipo === 'urgente' ? 'üö® Urgente' : 'üì¶ Normal'} ‚Ä¢ ${utils.formatCurrency(valor)}</p>
                        </div>
                        <button onclick="removerItem('${item.id}')" class="opacity-0 group-hover:opacity-100 p-2 text-red-500 hover:bg-red-50 rounded-lg transition">
                            ‚úï
                        </button>
                    `;
                    lista.appendChild(div);
                });
                
                valorEstimado.textContent = utils.formatCurrency(totalEstimado);
                resumo.classList.remove('hidden');
            }
        };

        // ===== GLOBAL FUNCTIONS =====
        window.toggleTheme = () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            ui.updateTheme();
        };

        window.handleEnter = (e) => {
            if (e.key === 'Enter') addLista();
        };

        window.getLocation = () => {
            if (!navigator.geolocation) {
                ui.toast('Geolocaliza√ß√£o n√£o suportada', 'error');
                return;
            }
            
            ui.toast('Obtendo localiza√ß√£o...', 'info');
            
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const { latitude, longitude } = pos.coords;
                    // Aqui voc√™ poderia usar geocoding reverso para obter o endere√ßo
                    document.getElementById('end').value = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                    ui.toast('Localiza√ß√£o obtida!', 'success');
                },
                (err) => {
                    ui.toast('Erro ao obter localiza√ß√£o', 'error');
                }
            );
        };

        window.addLista = () => {
            const input = document.getElementById('end');
            const endereco = input.value.trim();
            
            if (!endereco || endereco.length < 5) {
                ui.toast('Endere√ßo muito curto', 'error');
                return;
            }
            
            Store.rascunho.push({
                id: utils.generateId(),
                endereco,
                tipo: 'normal',
                addedAt: new Date().toISOString()
            });
            
            input.value = '';
            services.saveRascunho();
            controllers.renderRascunho();
            utils.playSound('success');
        };

        window.removerItem = (id) => {
            Store.rascunho = Store.rascunho.filter(item => item.id !== id);
            services.saveRascunho();
            controllers.renderRascunho();
        };

        window.chamarMoto = async (tipo = 'normal') => {
            if (!Store.perfil) return;
            
            const btn = event.currentTarget;
            ui.setLoading(btn, true);
            
            try {
                const result = await services.addToQueue('chamados', {
                    loja: Store.perfil.nome,
                    lojaId: Store.perfil.id,
                    tipo: tipo,
                    status: "Pendente",
                    prioridade: tipo === 'urgente' ? 1 : 0
                });
                
                if (result.offline) {
                    ui.toast('Chamado salvo (modo offline)', 'warning');
                } else {
                    ui.toast(tipo === 'urgente' ? 'üö® Entregador urgente chamado!' : 'üèçÔ∏è Entregador chamado!', 'success');
                    utils.playSound('success');
                }
            } catch (error) {
                console.error('Erro:', error);
                ui.toast('Erro ao chamar entregador', 'error');
            } finally {
                ui.setLoading(btn, false);
            }
        };

        window.enviarTudo = async () => {
            if (Store.rascunho.length === 0 || Store.processing) return;
            
            Store.processing = true;
            const btn = document.getElementById('btnEnviar');
            ui.setLoading(btn, true, 'Enviando...');
            
            try {
                const promises = Store.rascunho.map(item => 
                    services.addToQueue('pedidos', {
                        loja: Store.perfil.nome,
                        lojaId: Store.perfil.id,
                        local: item.endereco,
                        tipo: item.tipo,
                        status: "Fila",
                        zap: Store.perfil.zap,
                        valorEstimado: item.tipo === 'urgente' ? Store.config.taxaUrgente : Store.config.taxaPadrao
                    })
                );
                
                await Promise.all(promises);
                
                Store.rascunho = [];
                services.saveRascunho();
                controllers.renderRascunho();
                
                ui.toast(`‚úÖ ${promises.length} pedidos enviados!`, 'success');
                utils.playSound('success');
                
            } catch (error) {
                console.error('Erro ao enviar:', error);
                ui.toast('Erro ao enviar lote', 'error');
            } finally {
                Store.processing = false;
                ui.setLoading(btn, false);
            }
        };

        // Inicializar
        controllers.init();
    </script>
</body>
</html>
