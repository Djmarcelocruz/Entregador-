<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Marcelo Entregas</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-4 font-sans min-h-screen">
    <div class="max-w-md mx-auto pb-20">
        
        <!-- CADASTRO -->
        <div id="cadastro" class="hidden bg-white p-6 rounded-3xl shadow-xl">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-blue-600 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-3xl">üè™</div>
                <h2 class="text-2xl font-black text-gray-800">Bem-vindo!</h2>
            </div>
            
            <div class="space-y-4">
                <input id="nLoja" placeholder="Nome da loja" autocomplete="off" class="w-full p-4 bg-gray-50 rounded-xl border-2 border-gray-200 focus:border-blue-500 outline-none font-bold text-sm">
                <input id="zLoja" placeholder="WhatsApp (11 digitos)" type="tel" maxlength="11" autocomplete="off" class="w-full p-4 bg-gray-50 rounded-xl border-2 border-gray-200 focus:border-blue-500 outline-none font-bold text-sm">
                <input id="eLoja" placeholder="Endereco completo" autocomplete="off" class="w-full p-4 bg-gray-50 rounded-xl border-2 border-gray-200 focus:border-blue-500 outline-none font-bold text-sm">
                <button onclick="salvar()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black uppercase shadow-lg">
                    Comecar
                </button>
            </div>
        </div>

        <!-- PAINEL -->
        <div id="painel" class="hidden space-y-4">
            
            <!-- HEADER -->
            <div class="bg-blue-600 p-4 rounded-2xl shadow-lg text-white flex justify-between items-center">
                <div>
                    <p class="text-xs opacity-80">Sua Loja</p>
                    <h1 id="nomeLoja" class="text-lg font-black"></h1>
                </div>
                <div class="text-right">
                    <p class="text-xs opacity-80">Marcelo</p>
                    <span id="statusMarcelo" class="text-xs font-bold bg-white/20 px-2 py-1 rounded">...</span>
                </div>
            </div>

            <!-- CHAMAR -->
            <button id="btnChamar" onclick="chamar()" class="w-full bg-orange-500 text-white p-5 rounded-2xl font-black shadow-xl uppercase text-lg disabled:opacity-50">
                üîî Chamar Marcelo
            </button>

            <!-- NOVA ENTREGA -->
            <div class="bg-white p-5 rounded-2xl shadow-lg">
                <h2 class="font-black text-gray-800 mb-3 flex items-center gap-2">
                    <span>üì¶</span> Nova Entrega
                </h2>

                <div class="space-y-3">
                    <input id="end" placeholder="Rua e numero" autocomplete="off" class="w-full p-4 bg-blue-50 rounded-xl font-bold text-sm outline-none">
                    <input id="ref" placeholder="Referencia (opcional)" autocomplete="off" class="w-full p-4 bg-gray-50 rounded-xl font-bold text-sm outline-none">
                    
                    <div class="grid grid-cols-2 gap-3">
                        <select id="pag" class="p-4 bg-gray-50 rounded-xl font-bold text-xs outline-none">
                            <option value="PAGO">J√° Pago</option>
                            <option value="DINHEIRO">Dinheiro</option>
                            <option value="PIX">PIX</option>
                            <option value="CARTAO">Cart√£o</option>
                        </select>
                        <input id="troco" type="number" placeholder="Troco?" class="hidden p-4 bg-gray-50 rounded-xl font-bold text-sm outline-none">
                    </div>

                    <button onclick="add()" class="w-full bg-slate-800 text-white p-4 rounded-xl font-black uppercase shadow-lg flex items-center justify-center gap-2">
                        <span>+</span> Adicionar
                    </button>
                </div>

                <div id="lista" class="space-y-2 mt-4"></div>
                
                <button id="btnEnv" onclick="enviar()" class="hidden w-full bg-green-600 text-white p-4 rounded-xl font-black shadow-xl uppercase mt-4">
                    Enviar <span id="qtd">0</span>
                </button>
            </div>

            <!-- MINHAS ENTREGAS -->
            <div class="bg-white p-4 rounded-2xl shadow-lg">
                <h3 class="font-black text-gray-800 mb-3">üìã Entregas Hoje</h3>
                <div id="minhas" class="space-y-2 text-sm"></div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, Timestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBjP9dxFEp09DpZl5JkVMD05uaKoQTNDpE", 
            authDomain: "meuappentregas.firebaseapp.com", 
            projectId: "meuappentregas", 
            storageBucket: "meuappentregas.firebasestorage.app", 
            messagingSenderId: "442484186787", 
            appId: "1:442484186787:web:ac914827ebebda987f2916" 
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let loja = JSON.parse(localStorage.getItem('marcelo_loja'));
        let rascunho = [];

        document.getElementById('pag').addEventListener('change', function() {
            document.getElementById('troco').classList.toggle('hidden', !['DINHEIRO', 'PIX'].includes(this.value));
        });

        function init() {
            if (!loja || !loja.endereco) {
                document.getElementById('cadastro').classList.remove('hidden');
            } else {
                mostrar();
            }
        }

        function mostrar() {
            document.getElementById('painel').classList.remove('hidden');
            document.getElementById('nomeLoja').textContent = loja.nome;

            onSnapshot(doc(db, 'config', 'status'), (doc) => {
                const s = doc.data() || { online: false, ocupado: false };
                const el = document.getElementById('statusMarcelo');
                const btn = document.getElementById('btnChamar');
                
                if (s.online && !s.ocupado) {
                    el.textContent = 'Dispon√≠vel';
                    el.className = 'text-xs font-bold bg-green-500 px-2 py-1 rounded text-white';
                    btn.disabled = false;
                } else if (s.ocupado) {
                    el.textContent = 'Em entrega';
                    el.className = 'text-xs font-bold bg-orange-500 px-2 py-1 rounded text-white';
                    btn.disabled = true;
                } else {
                    el.textContent = 'Offline';
                    el.className = 'text-xs font-bold bg-red-500 px-2 py-1 rounded text-white';
                    btn.disabled = true;
                }
            });

            carregar();
            setInterval(carregar, 10000);
        }

        async function carregar() {
            const div = document.getElementById('minhas');
            const snap = await getDocs(collection(db, 'pedidos'));
            const entregas = [];
            
            snap.forEach(d => {
                const p = d.data();
                if (p.loja === loja.nome && p.status !== 'Concluido') entregas.push(p);
            });

            div.innerHTML = entregas.length === 0 ? '<p class="text-gray-400 text-xs">Nenhuma ativa</p>' : '';
            
            entregas.forEach(p => {
                const status = { 'Ativo': '‚è≥', 'SaiuParaEntrega': 'üõµ', 'Chegou': '‚úÖ' };
                div.innerHTML += `
                    <div class="p-3 bg-gray-50 rounded-xl border-l-4 border-blue-500">
                        <div class="flex justify-between">
                            <p class="font-bold text-xs truncate">${p.local}</p>
                            <span>${status[p.status] || '‚è≥'}</span>
                        </div>
                        <p class="text-xs text-gray-500">${p.pag}</p>
                    </div>
                `;
            });
        }

        window.chamar = async () => {
            const btn = document.getElementById('btnChamar');
            btn.disabled = true;
            btn.textContent = 'Chamando...';
            
            try {
                await addDoc(collection(db, 'chamadas'), {
                    loja: loja.nome,
                    zap: loja.zap,
                    enderecoLoja: loja.endereco,
                    hora: Timestamp.now(),
                    status: 'Pendente'
                });
                
                btn.textContent = '‚úÖ Chamado!';
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = 'üîî Chamar Marcelo';
                }, 10000);
            } catch (e) {
                alert('Erro: ' + e.message);
                btn.disabled = false;
                btn.textContent = 'üîî Chamar Marcelo';
            }
        };

        window.add = () => {
            const rua = document.getElementById('end').value.trim();
            if (!rua) return alert('Informe o endere√ßo');
            
            let pag = document.getElementById('pag').value;
            const troco = document.getElementById('troco').value;
            if (troco) pag += ` (Troco: R$${troco})`;
            
            rascunho.push({
                local: rua,
                ref: document.getElementById('ref').value,
                pag: pag,
                obs: ''
            });
            
            document.getElementById('end').value = '';
            document.getElementById('ref').value = '';
            document.getElementById('troco').value = '';
            mostrarLista();
        };

        function mostrarLista() {
            const div = document.getElementById('lista');
            div.innerHTML = rascunho.map((item, i) => `
                <div class="p-3 bg-blue-50 rounded-xl border-l-4 border-blue-600 flex justify-between">
                    <div>
                        <p class="font-bold text-sm">${item.local}</p>
                        <p class="text-xs text-blue-600">${item.pag}</p>
                    </div>
                    <button onclick="remover(${i})" class="text-red-500 font-black">√ó</button>
                </div>
            `).join('');
            
            const btn = document.getElementById('btnEnv');
            document.getElementById('qtd').textContent = rascunho.length;
            rascunho.length > 0 ? btn.classList.remove('hidden') : btn.classList.add('hidden');
        }

        window.remover = (i) => {
            rascunho.splice(i, 1);
            mostrarLista();
        };

        window.enviar = async () => {
            const btn = document.getElementById('btnEnv');
            btn.textContent = 'Enviando...';
            
            try {
                for (const item of rascunho) {
                    await addDoc(collection(db, 'pedidos'), {
                        loja: loja.nome,
                        zap: loja.zap,
                        local: item.local,
                        referencia: item.ref,
                        pag: item.pag,
                        status: 'Ativo',
                        hora: Timestamp.now()
                    });
                }
                
                rascunho = [];
                mostrarLista();
                btn.textContent = '‚úÖ Enviado!';
                setTimeout(() => {
                    btn.classList.add('hidden');
                    btn.textContent = 'Enviar <span id="qtd">0</span>';
                }, 2000);
            } catch (e) {
                alert('Erro: ' + e.message);
                btn.textContent = 'Enviar <span id="qtd">' + rascunho.length + '</span>';
            }
        };

        window.salvar = () => {
            const n = document.getElementById('nLoja').value.trim();
            const z = document.getElementById('zLoja').value.trim();
            const e = document.getElementById('eLoja').value.trim();
            
            if (!n || !z || !e) return alert('Preencha tudo');
            if (z.length !== 11) return alert('WhatsApp inv√°lido');
            
            localStorage.setItem('marcelo_loja', JSON.stringify({ nome: n, zap: z, endereco: e }));
            location.reload();
        };

        init();
    </script>
</body>
</html>
