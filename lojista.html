<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chamar Entregador</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4 font-sans">
    <div class="max-w-md mx-auto">
        <div id="cadastro" class="hidden bg-white p-8 rounded-[30px] shadow-2xl">
            <h2 class="text-2xl font-black text-blue-900 mb-6 uppercase text-center">Configurar Loja</h2>
            <input id="nLoja" placeholder="Nome da Loja" class="w-full p-4 mb-3 bg-gray-50 rounded-2xl border-2 border-gray-100 outline-none focus:border-blue-500 font-bold">
            <input id="zLoja" placeholder="WhatsApp (DDD+NÃºmero)" class="w-full p-4 mb-6 bg-gray-50 rounded-2xl border-2 border-gray-100 outline-none focus:border-blue-500 font-bold">
            <button onclick="salvarLoja()" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl shadow-lg uppercase">ComeÃ§ar</button>
        </div>

        <div id="painel" class="hidden space-y-4">
            <div class="bg-white p-5 rounded-3xl shadow-md flex justify-between items-center">
                <h1 id="exibirNome" class="font-black text-blue-900 uppercase italic"></h1>
                <span id="stStatus" class="text-[10px] font-black p-2 rounded-lg"></span>
            </div>

            <button onclick="chamar('PADRÃƒO')" class="w-full bg-blue-600 text-white font-black py-6 rounded-[25px] shadow-xl text-lg uppercase italic">Solicitar Entregador</button>
            <button onclick="chamar('URGENTE')" class="w-full bg-red-600 text-white font-black py-4 rounded-[20px] shadow-lg text-sm uppercase italic">ðŸš¨ Chamado Urgente</button>

            <div class="bg-white p-6 rounded-[30px] shadow-xl">
                <h3 class="font-black text-gray-400 text-xs mb-4 uppercase italic">Montar Lista de Entregas</h3>
                <input id="inputEnd" placeholder="EndereÃ§o: Rua, NÃºmero, Bairro" class="w-full p-4 bg-gray-50 rounded-2xl mb-2 font-bold outline-none border-2 border-transparent focus:border-blue-500">
                <button onclick="addLista()" class="w-full bg-gray-800 text-white font-black py-3 rounded-xl mb-4">+ Adicionar Ã  Lista</button>
                
                <div id="listaRascunho" class="space-y-2 max-h-48 overflow-y-auto"></div>
                
                <button id="btnEnviarLote" onclick="enviarLote()" class="hidden w-full bg-green-600 text-white font-black py-5 rounded-2xl mt-4 shadow-lg animate-pulse uppercase">Enviar Todas Agora âœ…</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBjP9dxFEp09DpZl5JkVMD05uaKoQTNDpE", authDomain: "meuappentregas.firebaseapp.com", projectId: "meuappentregas", storageBucket: "meuappentregas.firebasestorage.app", messagingSenderId: "442484186787", appId: "1:442484186787:web:ac914827ebebda987f2916" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        let dadosLoja = JSON.parse(localStorage.getItem('marcelo_loja'));
        let rascunho = [];

        window.onload = () => {
            if(!dadosLoja) document.getElementById('cadastro').classList.remove('hidden');
            else {
                document.getElementById('painel').classList.remove('hidden');
                document.getElementById('exibirNome').innerText = dadosLoja.nome;
                onSnapshot(doc(db, "config", "status"), (d) => {
                    const s = d.data() || {};
                    const el = document.getElementById('stStatus');
                    el.innerText = s.online ? (s.ocupado ? "EM ROTA ðŸ›µ" : "ONLINE ðŸŸ¢") : "OFFLINE ðŸ”´";
                    el.className = `text-[10px] font-black p-2 rounded-lg ${s.online ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`;
                });
            }
        };

        window.salvarLoja = () => {
            const nome = document.getElementById('nLoja').value;
            const zap = document.getElementById('zLoja').value;
            if(nome && zap) {
                localStorage.setItem('marcelo_loja', JSON.stringify({nome, zap}));
                location.reload();
            }
        };

        window.chamar = async (tipo) => {
            await addDoc(collection(db, "chamados"), { loja: dadosLoja.nome, tipo, zap: dadosLoja.zap, status: "Pendente", hora: Date.now() });
            alert("Marcelo avisado!");
        };

        window.addLista = () => {
            const input = document.getElementById('inputEnd');
            if(input.value) {
                rascunho.push(input.value);
                input.value = '';
                render();
            }
        };

        function render() {
            document.getElementById('listaRascunho').innerHTML = rascunho.map((e, i) => `<div class="p-3 bg-gray-50 rounded-xl flex justify-between font-bold text-sm"><span>${e}</span><button onclick="remover(${i})" class="text-red-500 font-black">X</button></div>`).join('');
            document.getElementById('btnEnviarLote').classList.toggle('hidden', rascunho.length === 0);
        }

        window.remover = (i) => { rascunho.splice(i, 1); render(); };

        window.enviarLote = async () => {
            for (const local of rascunho) {
                await addDoc(collection(db, "pedidos"), { loja: dadosLoja.nome, zap: dadosLoja.zap, local, status: "Fila", hora: Date.now() });
            }
            rascunho = []; render(); alert("Lote enviado com sucesso!");
        };
    </script>
</body>
</html>
