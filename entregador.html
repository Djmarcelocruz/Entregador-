<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Marcelo - Entregas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .online-ativo { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .chamada-ativa { animation: shake 0.5s infinite; }
        @keyframes shake { 
            0%, 100% { transform: translateX(0); } 
            25% { transform: translateX(-5px); } 
            75% { transform: translateX(5px); } 
        }
        .toast {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .resumo-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-slate-100 p-4 font-sans min-h-screen pb-32">
    <div class="max-w-md mx-auto">
        
        <!-- BOTAO INSTALAR -->
        <div id="areaInstalar" class="hidden bg-gradient-to-r from-green-500 to-green-600 p-4 rounded-2xl shadow-lg mb-4 text-white">
            <p class="text-sm font-bold mb-2">üì≤ Instale o App</p>
            <p class="text-xs mb-3 opacity-90">Receba notifica√ß√µes mesmo com o app fechado</p>
            <button onclick="instalarApp()" class="w-full bg-white text-green-600 p-3 rounded-xl font-black uppercase shadow-lg active:scale-95 transition-transform">
                Instalar Agora
            </button>
        </div>

        <!-- CONFIGURA√á√ÉO DE TAXA -->
        <div id="configTaxa" class="bg-white p-4 rounded-2xl shadow-lg mb-4">
            <p class="text-xs font-bold text-gray-400 uppercase mb-2">üí∞ Configurar Taxa de Entrega</p>
            <div class="flex gap-2 mb-2">
                <select id="tipoTaxa" class="flex-1 p-3 bg-gray-50 rounded-xl font-bold text-sm outline-none border-2 border-gray-200 focus:border-blue-500">
                    <option value="fixa">Taxa Fixa (R$)</option>
                    <option value="km">Por Quil√¥metro (R$/km)</option>
                </select>
                <input id="valorTaxa" type="number" step="0.01" placeholder="0.00" class="w-28 p-3 bg-gray-50 rounded-xl font-bold text-sm outline-none border-2 border-gray-200 focus:border-blue-500 text-center">
            </div>
            <button onclick="salvarTaxa()" class="w-full bg-blue-600 text-white p-2 rounded-xl font-bold text-sm active:scale-95 transition-transform">
                Salvar Configura√ß√£o
            </button>
            <p id="infoTaxa" class="text-xs text-gray-500 mt-2 text-center"></p>
        </div>

        <!-- HEADER STATUS -->
        <div id="headerStatus" class="bg-white p-4 rounded-2xl shadow-lg mb-4 flex justify-between items-center">
            <div>
                <p class="text-xs font-bold text-gray-400 uppercase">Meu Status</p>
                <p id="meuStatus" class="text-xl font-black text-red-600">‚óè Offline</p>
            </div>
            <button onclick="mudarStatus()" id="btnStatus" class="bg-red-500 text-white px-6 py-3 rounded-xl font-black text-sm uppercase shadow-lg active:scale-95 transition-transform">
                Ficar Online
            </button>
        </div>

        <!-- ESTAT√çSTICAS DO DIA -->
        <div class="grid grid-cols-3 gap-2 mb-4">
            <div class="bg-white p-3 rounded-xl shadow text-center">
                <p class="text-2xl font-black text-blue-600" id="statEntregas">0</p>
                <p class="text-xs text-gray-500">Entregas</p>
            </div>
            <div class="bg-white p-3 rounded-xl shadow text-center">
                <p class="text-2xl font-black text-green-600" id="statValor">R$0</p>
                <p class="text-xs text-gray-500">A Receber</p>
            </div>
            <div class="bg-white p-3 rounded-xl shadow text-center">
                <p class="text-2xl font-black text-purple-600" id="statPendentes">0</p>
                <p class="text-xs text-gray-500">Pendentes</p>
            </div>
        </div>

        <!-- NOTIFICA√á√ÉO DE CHAMADA -->
        <div id="notificacaoFlutuante" class="hidden fixed top-4 left-4 right-4 bg-gradient-to-r from-red-600 to-red-700 text-white p-6 rounded-2xl shadow-2xl z-50 chamada-ativa">
            <div class="flex items-center justify-between">
                <div class="flex-1 pr-4">
                    <p class="text-xs font-bold uppercase mb-1 animate-pulse">üîî NOVA CHAMADA!</p>
                    <p id="nomeLojaChamada" class="text-2xl font-black leading-tight">Loja</p>
                    <p id="enderecoLojaChamada" class="text-sm opacity-90 mt-1 line-clamp-2">Endere√ßo</p>
                    <p id="distanciaChamada" class="text-xs bg-white/20 inline-block px-2 py-1 rounded mt-2 font-bold">Calculando...</p>
                </div>
                <div class="flex flex-col gap-2">
                    <button onclick="aceitarChamadaFlutuante()" class="bg-white text-red-600 px-5 py-3 rounded-xl font-black text-lg shadow-lg active:scale-95 transition-transform">
                        VOU! üèçÔ∏è
                    </button>
                    <button onclick="recusarChamada()" class="bg-red-800 text-white px-4 py-2 rounded-xl font-bold text-sm opacity-80 active:scale-95 transition-transform">
                        N√£o posso
                    </button>
                </div>
            </div>
        </div>

        <!-- CHAMADAS PENDENTES -->
        <div id="areaChamadas" class="mb-4"></div>

        <!-- ENTREGAS PENDENTES -->
        <div id="areaEntregas" class="space-y-4 mb-4"></div>

        <!-- RESUMO DO DIA (WHATSAPP AQUI!) -->
        <div id="areaResumo" class="hidden mb-4">
            <div class="resumo-card text-white p-5 rounded-2xl shadow-xl">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <p class="text-xs font-bold uppercase opacity-80">Resumo do Dia</p>
                        <p class="text-2xl font-black" id="resumoTitulo">0 Entregas</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs font-bold uppercase opacity-80">Total</p>
                        <p class="text-2xl font-black" id="resumoValor">R$0</p>
                    </div>
                </div>
                
                <div id="listaResumo" class="bg-white/10 rounded-xl p-3 mb-4 max-h-40 overflow-y-auto text-sm space-y-1">
                    <!-- Lista de entregas conclu√≠das -->
                </div>

                <button onclick="enviarResumoWhatsApp()" class="w-full bg-white text-purple-700 p-4 rounded-xl font-black text-lg shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform">
                    <span class="text-2xl">üì±</span>
                    ENVIAR RESUMO NO WHATSAPP
                </button>
                
                <p class="text-xs text-center mt-2 opacity-80">
                    S√≥ clique quando terminar todas as entregas!
                </p>
            </div>
        </div>

        <!-- BOT√ÉO LIMPAR RESUMO (Ap√≥s enviar) -->
        <button id="btnNovoDia" onclick="novoDia()" class="hidden w-full bg-gray-600 text-white p-4 rounded-2xl font-black uppercase shadow-lg mt-4 active:scale-95 transition-transform">
            üåÖ Iniciar Novo Dia
        </button>

    </div>

    <!-- TOAST CONTAINER -->
    <div id="toastContainer" class="fixed top-4 left-4 right-4 z-50 pointer-events-none"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, 
            updateDoc, Timestamp, query, where, getDocs 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBjP9dxFEp09DpZl5JkVMD05uaKoQTNDpE", 
            authDomain: "meuappentregas.firebaseapp.com", 
            projectId: "meuappentregas", 
            storageBucket: "meuappentregas.firebasestorage.app", 
            messagingSenderId: "442484186787", 
            appId: "1:442484186787:web:ac914827ebebda987f2916" 
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Estado global
        let online = false;
        let somAtivado = false;
        let chamadoAtual = null;
        let entregasHoje = []; // Todas as entregas
        let entregasConcluidas = []; // S√≥ as conclu√≠das
        let configTaxa = JSON.parse(localStorage.getItem('marcelo_taxa')) || { tipo: 'fixa', valor: 5 };
        let wakeLock = null;
        let audioContext = null;
        let resumoEnviado = false; // Controle para n√£o duplicar

        // üéµ SISTEMA DE √ÅUDIO
        function initAudio() {
            if (somAtivado) return;
            
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            window.tocarSomChamada = () => {
                if (!audioContext) return;
                
                const playBeep = () => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.frequency.setValueAtTime(880, audioContext.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(440, audioContext.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    osc.start(audioContext.currentTime);
                    osc.stop(audioContext.currentTime + 0.5);
                };

                playBeep();
                window.intervaloSom = setInterval(playBeep, 1500);
            };
            
            window.pararSomChamada = () => {
                if (window.intervaloSom) {
                    clearInterval(window.intervaloSom);
                    window.intervaloSom = null;
                }
            };
            
            somAtivado = true;
        }

        document.addEventListener('click', initAudio, { once: true });
        document.addEventListener('touchstart', initAudio, { once: true });

        // üîî NOTIFICA√á√ïES PUSH
        async function initPushNotifications() {
            if (!('serviceWorker' in navigator)) return;
            
            try {
                const registration = await navigator.serviceWorker.register('/sw.js');
                
                if ('Notification' in window) {
                    const permission = await Notification.requestPermission();
                }
                
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data.type === 'ACEITAR_CHAMADA') {
                        aceitar(event.data.chamadaId);
                    }
                });
                
            } catch (err) {
                registrarSWInline();
            }
        }

        function registrarSWInline() {
            const swCode = `
                self.addEventListener('push', e => {
                    const data = e.data.json();
                    e.waitUntil(
                        self.registration.showNotification('üîî NOVA CHAMADA!', {
                            body: data.body,
                            icon: 'https://cdn-icons-png.flaticon.com/512/2830/2830305.png',
                            vibrate: [500, 200, 500],
                            requireInteraction: true,
                            actions: [
                                { action: 'aceitar', title: '‚úÖ Vou!' },
                                { action: 'recusar', title: '‚ùå N√£o' }
                            ]
                        })
                    );
                });
                self.addEventListener('notificationclick', e => {
                    e.notification.close();
                    e.waitUntil(clients.openWindow('/'));
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            navigator.serviceWorker.register(swUrl);
        }

        // üìç CALCULAR DIST√ÇNCIA
        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return (R * c).toFixed(1);
        }

        // üí∞ C√ÅLCULO DE TAXA
        function calcularTaxa(distanciaKm) {
            if (configTaxa.tipo === 'fixa') {
                return parseFloat(configTaxa.valor);
            } else {
                return (distanciaKm * parseFloat(configTaxa.valor)).toFixed(2);
            }
        }

        function salvarTaxa() {
            configTaxa = {
                tipo: document.getElementById('tipoTaxa').value,
                valor: parseFloat(document.getElementById('valorTaxa').value) || 0
            };
            localStorage.setItem('marcelo_taxa', JSON.stringify(configTaxa));
            atualizarInfoTaxa();
            showToast('‚úÖ Taxa salva!', 'success');
        }

        function atualizarInfoTaxa() {
            const info = configTaxa.tipo === 'fixa' 
                ? `Taxa fixa: R$${configTaxa.valor.toFixed(2)}` 
                : `R$${configTaxa.valor.toFixed(2)} por km`;
            document.getElementById('infoTaxa').textContent = info;
        }

        // üü¢ MUDAR STATUS
        window.mudarStatus = async () => {
            online = !online;
            
            if (online && 'wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                } catch (e) {}
            } else if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
            
            await setDoc(doc(db, 'config', 'status'), { 
                online, 
                ocupado: false,
                ultimaAtualizacao: Timestamp.now()
            }, { merge: true });
        };

        // Listener de status
        onSnapshot(doc(db, 'config', 'status'), (doc) => {
            const s = doc.data() || { online: false };
            online = s.online;
            const statusEl = document.getElementById('meuStatus');
            const btn = document.getElementById('btnStatus');
            const header = document.getElementById('headerStatus');
            
            if (online) {
                statusEl.textContent = '‚óè Online';
                statusEl.className = 'text-xl font-black text-green-600';
                btn.textContent = 'Ficar Offline';
                btn.className = 'bg-green-600 text-white px-6 py-3 rounded-xl font-black text-sm uppercase shadow-lg active:scale-95 transition-transform';
                header.classList.add('online-ativo');
            } else {
                statusEl.textContent = '‚óè Offline';
                statusEl.className = 'text-xl font-black text-red-600';
                btn.textContent = 'Ficar Online';
                btn.className = 'bg-red-500 text-white px-6 py-3 rounded-xl font-black text-sm uppercase shadow-lg active:scale-95 transition-transform';
                header.classList.remove('online-ativo');
            }
        });

        // üîî CHAMADAS COM ANTI-DUPLICATA
        let chamadasProcessadas = new Set();
        
        onSnapshot(collection(db, 'chamadas'), (snap) => {
            const div = document.getElementById('areaChamadas');
            const notifFlutuante = document.getElementById('notificacaoFlutuante');
            
            let chamadoParaMim = null;
            
            snap.forEach((d) => {
                const c = d.data();
                if (c.status === 'Pendente' && !chamadasProcessadas.has(d.id)) {
                    chamadoParaMim = { id: d.id, ...c };
                }
            });

            if (chamadoParaMim && online && !chamadoAtual) {
                processarNovaChamada(chamadoParaMim);
            } else if (!chamadoParaMim && chamadoAtual) {
                notifFlutuante.classList.add('hidden');
                chamadoAtual = null;
                window.pararSomChamada();
            }

            renderizarChamadas(snap);
        });

        async function processarNovaChamada(chamado) {
            chamadoAtual = chamado.id;
            chamadasProcessadas.add(chamado.id);
            
            if (somAtivado) window.tocarSomChamada();
            if (navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 500]);
            
            let distanciaTexto = 'Dist√¢ncia desconhecida';
            if (chamado.coords && navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    const dist = calcularDistancia(
                        pos.coords.latitude, pos.coords.longitude,
                        chamado.coords.lat, chamado.coords.lng
                    );
                    const taxa = calcularTaxa(dist);
                    distanciaTexto = `${dist}km - Taxa: R$${taxa}`;
                    document.getElementById('distanciaChamada').textContent = distanciaTexto;
                });
            }
            
            document.getElementById('nomeLojaChamada').textContent = chamado.loja;
            document.getElementById('enderecoLojaChamada').textContent = chamado.enderecoLoja;
            document.getElementById('distanciaChamada').textContent = distanciaTexto;
            document.getElementById('notificacaoFlutuante').classList.remove('hidden');
            
            if ('Notification' in window && Notification.permission === 'granted') {
                try {
                    const registration = await navigator.serviceWorker.ready;
                    await registration.showNotification('üîî NOVA CHAMADA!', {
                        body: `${chamado.loja} - ${chamado.enderecoLoja}`,
                        icon: 'https://cdn-icons-png.flaticon.com/512/2830/2830305.png',
                        tag: 'chamada-' + chamado.id,
                        requireInteraction: true,
                        actions: [
                            { action: 'aceitar', title: '‚úÖ Vou!' },
                            { action: 'recusar', title: '‚ùå N√£o posso' }
                        ],
                        data: { chamadaId: chamado.id }
                    });
                } catch (e) {
                    new Notification('üîî NOVA CHAMADA!', {
                        body: `${chamado.loja} - ${chamado.enderecoLoja}`,
                        requireInteraction: true
                    });
                }
            }
            
            setTimeout(() => {
                if (chamadoAtual === chamado.id) recusarChamada();
            }, 120000);
        }

        function renderizarChamadas(snap) {
            const div = document.getElementById('areaChamadas');
            let html = '';
            
            snap.forEach((d) => {
                const c = d.data();
                if (c.status === 'Pendente') {
                    html += `
                        <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-2xl shadow-lg mb-2 flex justify-between items-center animate-pulse">
                            <div class="flex-1 pr-2">
                                <p class="font-black text-lg">üîî ${c.loja}</p>
                                <p class="text-xs opacity-90 line-clamp-1">${c.enderecoLoja}</p>
                            </div>
                            <button onclick="aceitar('${d.id}')" class="bg-white text-orange-600 px-4 py-2 rounded-xl font-black text-lg shadow-lg active:scale-95 transition-transform">
                                VOU!
                            </button>
                        </div>
                    `;
                } else if (c.status === 'Visualizado') {
                    html += `
                        <div class="bg-slate-800 text-white p-3 rounded-xl border-l-4 border-green-500 mb-2 flex justify-between items-center">
                            <div>
                                <p class="font-black">${c.loja}</p>
                                <p class="text-xs text-green-400">Voc√™ est√° indo!</p>
                            </div>
                            <button onclick="pronto('${d.id}')" class="bg-green-600 text-white px-3 py-1 rounded-lg font-black text-xs active:scale-95">
                                ‚úÖ Cheguei
                            </button>
                        </div>
                    `;
                }
            });
            
            div.innerHTML = html || '';
        }

        // ‚úÖ ACEITAR/RECUSAR/PRONTO
        window.aceitarChamadaFlutuante = () => {
            if (chamadoAtual) aceitar(chamadoAtual);
        };

        window.aceitar = async (id) => {
            window.pararSomChamada();
            
            try {
                await updateDoc(doc(db, 'chamadas', id), { 
                    status: 'Visualizado',
                    aceitoEm: Timestamp.now()
                });
                
                await setDoc(doc(db, 'config', 'status'), { 
                    online: true, 
                    ocupado: true,
                    entregaAtual: id
                }, { merge: true });
                
                document.getElementById('notificacaoFlutuante').classList.add('hidden');
                showToast('‚úÖ Chamada aceita! V√° at√© a loja.', 'success');
                
            } catch (e) {
                showToast('‚ùå Erro ao aceitar', 'error');
            }
        };

        window.recusarChamada = async () => {
            if (!chamadoAtual) return;
            
            window.pararSomChamada();
            document.getElementById('notificacaoFlutuante').classList.add('hidden');
            
            await updateDoc(doc(db, 'chamadas', chamadoAtual), { 
                status: 'Recusado',
                recusadoEm: Timestamp.now()
            });
            
            chamadoAtual = null;
            showToast('Chamada recusada', 'info');
        };

        window.pronto = async (id) => {
            await deleteDoc(doc(db, 'chamadas', id));
            await setDoc(doc(db, 'config', 'status'), { 
                online: true, 
                ocupado: false,
                entregaAtual: null
            }, { merge: true });
            
            showToast('‚úÖ Chegou na loja! Aguardando entregas.', 'success');
        };

        // üì¶ ENTREGAS - ATUALIZA√á√ÉO EM TEMPO REAL
        onSnapshot(collection(db, 'pedidos'), (snap) => {
            entregasHoje = [];
            entregasConcluidas = [];
            let pendentes = 0;
            let totalValor = 0;
            
            snap.forEach((d) => {
                const p = d.data();
                const entrega = { id: d.id, ...p };
                entregasHoje.push(entrega);
                
                if (p.status === 'Concluido') {
                    entregasConcluidas.push(entrega);
                    totalValor += parseFloat(p.taxa || 0);
                } else {
                    pendentes++;
                }
            });

            // Atualizar estat√≠sticas
            document.getElementById('statEntregas').textContent = entregasConcluidas.length;
            document.getElementById('statValor').textContent = `R$${totalValor.toFixed(0)}`;
            document.getElementById('statPendentes').textContent = pendentes;

            // Mostrar/esconder resumo
            atualizarAreaResumo();

            // Renderizar entregas pendentes
            renderizarEntregasPendentes();
        });

        function atualizarAreaResumo() {
            const areaResumo = document.getElementById('areaResumo');
            const btnNovoDia = document.getElementById('btnNovoDia');
            
            if (entregasConcluidas.length === 0 || resumoEnviado) {
                areaResumo.classList.add('hidden');
                if (resumoEnviado && entregasConcluidas.length > 0) {
                    btnNovoDia.classList.remove('hidden');
                } else {
                    btnNovoDia.classList.add('hidden');
                }
                return;
            }

            // Calcular total
            let total = 0;
            entregasConcluidas.forEach(e => {
                total += parseFloat(e.taxa || 0);
            });

            // Atualizar t√≠tulo
            document.getElementById('resumoTitulo').textContent = `${entregasConcluidas.length} Entrega${entregasConcluidas.length > 1 ? 's' : ''}`;
            document.getElementById('resumoValor').textContent = `R$${total.toFixed(2)}`;

            // Montar lista visual
            const lista = document.getElementById('listaResumo');
            lista.innerHTML = entregasConcluidas.map((e, i) => `
                <div class="flex justify-between items-center py-1 border-b border-white/20 last:border-0">
                    <span class="truncate flex-1">${i+1}. ${e.loja} - ${e.local.substring(0, 20)}...</span>
                    <span class="font-bold">R$${parseFloat(e.taxa || 0).toFixed(2)}</span>
                </div>
            `).join('');

            areaResumo.classList.remove('hidden');
        }

        function renderizarEntregasPendentes() {
            const div = document.getElementById('areaEntregas');
            const pendentes = entregasHoje.filter(e => e.status !== 'Concluido');
            
            if (pendentes.length === 0) {
                div.innerHTML = '';
                return;
            }

            // Agrupar por loja
            const porLoja = {};
            pendentes.forEach(p => {
                if (!porLoja[p.loja]) porLoja[p.loja] = [];
                porLoja[p.loja].push(p);
            });

            let html = '<h2 class="font-black text-gray-800 uppercase mb-2 text-sm">üì¶ Entregas em Andamento</h2>';
            
            for (let loja in porLoja) {
                const entregas = porLoja[loja];
                html += `
                    <div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-3">
                        <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-3 text-white">
                            <p class="font-black text-sm">${loja}</p>
                            <p class="text-xs opacity-90">${entregas.length} entrega(s)</p>
                        </div>
                        <div class="p-3 space-y-2">
                            ${entregas.map(e => `
                                <div class="p-3 bg-gray-50 rounded-xl border-l-4 ${e.status === 'SaiuParaEntrega' ? 'border-orange-500' : 'border-blue-500'}">
                                    <p class="font-bold text-sm text-gray-800">${e.local}</p>
                                    <p class="text-xs text-blue-600 font-bold">${e.pag}</p>
                                    ${e.taxa ? `<p class="text-xs text-green-600">Taxa: R$${e.taxa}</p>` : ''}
                                    ${e.obs ? `<p class="text-xs text-orange-600 mt-1">‚ö†Ô∏è ${e.obs}</p>` : ''}
                                    <div class="flex gap-2 mt-2">
                                        ${e.status !== 'SaiuParaEntrega' ? `
                                            <button onclick="sair('${e.id}')" class="flex-1 bg-orange-500 text-white py-2 rounded-lg font-black text-sm active:scale-95 transition-transform">
                                                üõµ Sair
                                            </button>
                                        ` : `
                                            <button onclick="entregue('${e.id}', '${e.taxa || 0}')" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-black text-sm active:scale-95 transition-transform">
                                                ‚úÖ Entregue
                                            </button>
                                        `}
                                        <button onclick="maps('${encodeURIComponent(e.local)}')" class="bg-blue-100 text-blue-600 px-3 rounded-lg font-black active:scale-95">
                                            üó∫Ô∏è
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            div.innerHTML = html;
        }

        window.sair = async (id) => {
            let taxa = configTaxa.valor;
            
            if (configTaxa.tipo === 'km' && navigator.geolocation) {
                try {
                    const pos = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject);
                    });
                    taxa = calcularTaxa(2); // Estimativa
                } catch (e) {}
            }
            
            await updateDoc(doc(db, 'pedidos', id), { 
                status: 'SaiuParaEntrega',
                taxa: taxa.toFixed(2),
                saiuEm: Timestamp.now()
            });
            
            showToast('üõµ Saiu para entrega!', 'success');
        };

        // ‚úÖ ENTREGUE - SEM WHATSAPP INDIVIDUAL!
        window.entregue = async (id, taxa) => {
            const nome = prompt('Quem recebeu a entrega?');
            if (!nome) return;
            
            try {
                await updateDoc(doc(db, 'pedidos', id), {
                    status: 'Concluido',
                    recebedor: nome,
                    horaEntrega: Timestamp.now(),
                    taxa: parseFloat(taxa).toFixed(2)
                });
                
                // ‚ùå N√ÉO ENVIA WHATSAPP AQUI!
                // Apenas mostra confirma√ß√£o local
                showToast(`‚úÖ Entrega conclu√≠da!`, 'success');
                showToast(`üíæ Salva no resumo do dia`, 'info');
                
            } catch (e) {
                showToast('‚ùå Erro ao finalizar', 'error');
            }
        };

        window.maps = (end) => {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${end}`, '_blank');
        };

        // üì± ENVIAR RESUMO NO WHATSAPP (S√ì AQUI!)
        window.enviarResumoWhatsApp = () => {
            if (entregasConcluidas.length === 0) {
                showToast('Nenhuma entrega conclu√≠da ainda!', 'error');
                return;
            }

            const hoje = new Date().toLocaleDateString('pt-BR');
            
            // Agrupar por loja
            const porLoja = {};
            let totalGeral = 0;
            
            entregasConcluidas.forEach(e => {
                if (!porLoja[e.loja]) porLoja[e.loja] = [];
                porLoja[e.loja].push(e);
                totalGeral += parseFloat(e.taxa || 0);
            });

            // Montar mensagem
            let texto = `üìä *RESUMO DO DIA - ${hoje}*\n\n`;
            texto += `*Total de Entregas:* ${entregasConcluidas.length}\n`;
            texto += `*Valor Total:* R$${totalGeral.toFixed(2)}\n\n`;
            texto += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;

            for (let loja in porLoja) {
                const entregas = porLoja[loja];
                let subtotal = 0;
                
                texto += `üè™ *${loja}*\n`;
                texto += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                
                entregas.forEach((e, i) => {
                    const taxa = parseFloat(e.taxa || 0);
                    subtotal += taxa;
                    
                    const hora = e.horaEntrega?.toDate ? 
                        e.horaEntrega.toDate().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}) : 
                        '--:--';
                    
                    texto += `\n*${i+1}.* ${e.local}\n`;
                    texto += `   üí∞ Pagamento: ${e.pag}\n`;
                    texto += `   üíµ Taxa: R$${taxa.toFixed(2)}\n`;
                    texto += `   üë§ Recebedor: ${e.recebedor || 'N√£o informado'}\n`;
                    texto += `   ‚è∞ ${hora}\n`;
                });
                
                texto += `\n   *Subtotal: R$${subtotal.toFixed(2)}*\n`;
                texto += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
            }

            texto += `üí∞ *TOTAL GERAL: R$${totalGeral.toFixed(2)}*`;

            // Confirmar antes de enviar
            if (!confirm(`Enviar resumo de ${entregasConcluidas.length} entregas para seu WhatsApp?\n\nTotal: R$${totalGeral.toFixed(2)}`)) {
                return;
            }

            // N√∫mero do entregador (configure aqui!)
            const meuZap = '14999999999'; // ‚¨ÖÔ∏è ALTERE PARA SEU N√öMERO
            
            const url = `https://wa.me/55${meuZap}?text=${encodeURIComponent(texto)}`;
            window.open(url, '_blank');
            
            resumoEnviado = true;
            showToast('üì± Resumo enviado com sucesso!', 'success');
            atualizarAreaResumo();
        };

        // üåÖ NOVO DIA - LIMPAR TUDO
        window.novoDia = () => {
            if (!confirm('Iniciar novo dia? Isso limpar√° o resumo atual.\n\nAs entregas continuar√£o salvas no hist√≥rico.')) {
                return;
            }
            
            resumoEnviado = false;
            entregasConcluidas = [];
            atualizarAreaResumo();
            showToast('üåÖ Novo dia iniciado! Boa sorte!', 'success');
        };

        // üçû TOAST
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            toast.className = `${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg mb-2 font-bold toast pointer-events-auto`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // üì≤ INSTALA√á√ÉO
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('areaInstalar').classList.remove('hidden');
        });

        window.instalarApp = async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('areaInstalar').classList.add('hidden');
                    showToast('‚úÖ App instalado!', 'success');
                }
            } else {
                showToast('üì± Adicione √† tela inicial manualmente', 'info');
            }
        };

        if (window.matchMedia('(display-mode: standalone)').matches) {
            document.getElementById('areaInstalar').classList.add('hidden');
        }

        // üöÄ INICIALIZA√á√ÉO
        document.addEventListener('DOMContentLoaded', () => {
            initPushNotifications();
            atualizarInfoTaxa();
            
            document.getElementById('tipoTaxa').value = configTaxa.tipo;
            document.getElementById('valorTaxa').value = configTaxa.valor;
            
            // Verificar URL params
            const params = new URLSearchParams(window.location.search);
            if (params.has('aceitar')) {
                setTimeout(() => aceitar(params.get('aceitar')), 1000);
            }
        });
    </script>
</body>
</html>
