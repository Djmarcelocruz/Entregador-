<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcelo - Painel Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyBjP9dxFEp09DpZl5JkVMD05uaKoQTNDpE", authDomain: "meuappentregas.firebaseapp.com", projectId: "meuappentregas", storageBucket: "meuappentregas.firebasestorage.app", messagingSenderId: "442484186787", appId: "1:442484186787:web:ac914827ebebda987f2916" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        let fechamentoLote = {};

        window.mudarStatus = async (tipo, val) => {
            const ref = doc(db, "config", "status");
            if(tipo === 'online') await updateDoc(ref, { online: val });
            if(tipo === 'ocupado') await updateDoc(ref, { ocupado: val });
        };

        onSnapshot(doc(db, "config", "status"), (d) => {
            const s = d.data();
            document.getElementById('btnStatus').innerText = s?.online ? "ONLINE üü¢" : "OFFLINE üî¥";
            document.getElementById('btnStatus').className = s?.online ? "flex-1 py-4 bg-green-500 text-white font-black rounded-2xl" : "flex-1 py-4 bg-red-500 text-white font-black rounded-2xl";
            document.getElementById('btnOcupado').innerText = s?.ocupado ? "EM ROTA üõµ" : "LIVRE ‚úÖ";
            document.getElementById('btnOcupado').className = s?.ocupado ? "flex-1 py-4 bg-orange-500 text-white font-black rounded-2xl" : "flex-1 py-4 bg-gray-400 text-white font-black rounded-2xl";
        });

        onSnapshot(query(collection(db, "chamados"), orderBy("timestamp", "desc")), (snaps) => {
            const div = document.getElementById('chamadas'); div.innerHTML = "";
            snaps.forEach(d => {
                const c = d.data();
                if(c.status === "Pendente") {
                    div.innerHTML += `<div class="bg-white p-6 rounded-[30px] shadow-xl mb-4 border-l-[12px] border-yellow-400">
                        <p class="font-black text-blue-900 mb-3">${c.loja} CHAMOU!</p>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="responder('${d.id}','5m')" class="bg-blue-600 text-white py-3 rounded-xl font-bold text-xs">5m</button>
                            <button onclick="responder('${d.id}','15m')" class="bg-blue-600 text-white py-3 rounded-xl font-bold text-xs">15m</button>
                            <button onclick="responder('${d.id}','30m')" class="bg-blue-600 text-white py-3 rounded-xl font-bold text-xs">30m</button>
                        </div>
                    </div>`;
                } else if(c.status === "Confirmado") {
                    div.innerHTML += `<div class="bg-blue-900 text-white p-6 rounded-3xl mb-4 flex justify-between items-center italic">
                        <span class="font-black uppercase">IR PARA: ${c.loja}</span>
                        <button onclick="cheguei('${d.id}')" class="bg-green-500 px-4 py-2 rounded-xl text-[10px] font-black">CHEGUEI</button>
                    </div>`;
                }
            });
        });

        onSnapshot(query(collection(db, "pedidos"), orderBy("timestamp", "asc")), (snaps) => {
            const div = document.getElementById('pedidos'); div.innerHTML = "";
            snaps.forEach(d => {
                const p = d.data();
                div.innerHTML += `<div class="bg-white p-6 rounded-[35px] shadow-xl mb-4 border-l-[12px] border-blue-700">
                    <p class="text-[10px] font-black text-blue-500 uppercase mb-1">${p.loja}</p>
                    <p class="font-black text-gray-800 mb-4">${p.local}</p>
                    <input id="rec-${d.id}" placeholder="Nome de quem recebeu" class="w-full p-3 bg-gray-100 rounded-xl mb-3 text-xs font-bold outline-none border-2 border-dashed border-gray-300">
                    <div class="flex items-center gap-2 mb-4 bg-gray-50 p-2 rounded-xl">
                        <span class="text-xs font-bold text-gray-400">R$</span><input id="val-${d.id}" type="number" value="7" class="w-full bg-transparent font-black text-green-600 outline-none">
                    </div>
                    <div class="flex gap-2">
                        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.local + ', Quintana')}" target="_blank" class="bg-slate-100 p-4 rounded-2xl font-black text-[10px]">MAPA üìç</a>
                        <button onclick="finalizar('${d.id}', '${p.loja}', '${p.local}', document.getElementById('val-${d.id}').value, document.getElementById('rec-${d.id}').value, '${p.zap}')" class="flex-1 bg-blue-600 text-white font-black py-4 rounded-2xl">CONCLUIR ‚úÖ</button>
                    </div>
                </div>`;
            });
        });

        window.responder = async (id, t) => await updateDoc(doc(db, "chamados", id), { status: "Respondido", tempo: t });
        window.cheguei = async (id) => { 
            await deleteDoc(doc(db, "chamados", id));
            await updateDoc(doc(db, "config", "status"), { chamadoAtivo: false });
        };
        
        window.finalizar = async (id, loja, local, valor, recebedor, zap) => {
            const hora = new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
            if(!fechamentoLote[loja]) fechamentoLote[loja] = { zap: zap, itens: [], total: 0 };
            fechamentoLote[loja].itens.push(`üìç ${local} | üë§ ${recebedor || 'S/ Nome'} | ‚è∞ ${hora} | R$ ${valor}`);
            fechamentoLote[loja].total += parseFloat(valor);
            await deleteDoc(doc(db, "pedidos", id));
            renderBotoes();
        };

        const renderBotoes = () => {
            const res = document.getElementById('resumos'); res.innerHTML = "";
            for (let l in fechamentoLote) {
                res.innerHTML += `<button onclick="enviarZap('${l}')" class="w-full bg-green-100 border-2 border-green-600 text-green-700 p-4 rounded-2xl mb-2 font-black text-xs uppercase shadow-sm">FECHAR LOTE: ${l} (R$ ${fechamentoLote[l].total.toFixed(2)})</button>`;
            }
        };

        window.enviarZap = (l) => {
            const d = fechamentoLote[l];
            const msg = window.encodeURIComponent(`*RELAT√ìRIO DE ENTREGAS - MARCELO*\n\n‚úÖ *LOJA: ${l}*\n\n${d.itens.join('\n')}\n\n*TOTAL DO LOTE: R$ ${d.total.toFixed(2)}*`);
            window.open(`https://api.whatsapp.com/send?phone=55${d.zap}&text=${msg}`);
            delete fechamentoLote[l]; renderBotoes();
        };
    </script>
</head>
<body class="bg-gray-100 p-4 pb-20">
    <div class="max-w-md mx-auto">
        <div class="flex gap-2 mb-4"><button id="btnStatus" onclick="mudarStatus('online', this.innerText.includes('OFFLINE'))"></button>
        <button id="btnOcupado" onclick="mudarStatus('ocupado', this.innerText.includes('LIVRE'))"></button></div>
        <div id="resumos"></div>
        <div id="chamadas"></div>
        <div id="pedidos"></div>
    </div>
</body>
</html>
