<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTWFyY2VsbyBFbnRyZWdhcyIsInNob3J0X25hbWUiOiJNYXJjZWxvIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmOGZhZmMiLCJ0aGVtZV9jb2xvciI6IiMyNTYzZWIiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0IiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCclM0UlM0NjaXJjbGUgY3g9JzUwJyBjeT0nNTAnIHI9JzQ1JyBmaWxsPSclMjMyNTYzZWInLyUzRSUzQ3RleHQgeD0nNTAnIHk9JzY1JyBmb250LXNpemU9JzUwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmaWxsPSd3aGl0ZSclM0UlNUN1M0Y2ODUlM0MlM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Marcelo - Entregas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .online-ativo { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .chamada-ativa { animation: shake 0.5s infinite; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body class="bg-slate-100 p-4 font-sans min-h-screen">
    <div class="max-w-md mx-auto pb-24">
        
        <!-- BOTAO INSTALAR (MANUAL) -->
        <div id="areaInstalar" class="hidden bg-green-100 p-4 rounded-2xl shadow-lg mb-4 border-2 border-green-500">
            <p class="text-sm font-bold text-green-800 mb-2">üì≤ Para receber notifica√ß√µes mesmo com tela fechada:</p>
            <ol class="text-xs text-green-700 mb-3 list-decimal pl-4">
                <li>Toque no bot√£o abaixo</li>
                <li>Confirme "Adicionar √† tela inicial"</li>
                <li>Pronto! Use pelo √≠cone do app</li>
            </ol>
            <button onclick="instalarManual()" class="w-full bg-green-600 text-white p-3 rounded-xl font-black uppercase shadow-lg">
                Instalar App Agora
            </button>
        </div>

        <!-- HEADER -->
        <div id="headerStatus" class="bg-white p-4 rounded-2xl shadow-lg mb-4 flex justify-between items-center">
            <div>
                <p class="text-xs font-bold text-gray-400 uppercase">Status</p>
                <p id="meuStatus" class="text-xl font-black text-red-600">‚óè Offline</p>
            </div>
            <button onclick="mudarStatus()" id="btnStatus" class="bg-red-500 text-white px-6 py-3 rounded-xl font-black text-sm uppercase shadow-lg">
                Ficar Online
            </button>
        </div>

        <!-- NOTIFICA√á√ÉO FLUTUANTE -->
        <div id="notificacaoFlutuante" class="hidden fixed top-4 left-4 right-4 bg-red-600 text-white p-6 rounded-2xl shadow-2xl z-50 chamada-ativa">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-bold uppercase mb-1">üîî NOVA CHAMADA!</p>
                    <p id="nomeLojaChamada" class="text-2xl font-black">Loja</p>
                    <p id="enderecoLojaChamada" class="text-sm opacity-90 mt-1">Endere√ßo</p>
                </div>
                <button onclick="aceitarChamadaFlutuante()" class="bg-white text-red-600 px-6 py-3 rounded-xl font-black text-lg shadow-lg">
                    VOU! üèçÔ∏è
                </button>
            </div>
        </div>

        <!-- CHAMADAS -->
        <div id="areaChamadas" class="mb-4"></div>

        <!-- ENTREGAS -->
        <div id="areaEntregas" class="space-y-4"></div>

        <!-- RESUMO -->
        <button id="btnResumo" onclick="gerarResumo()" class="hidden w-full bg-purple-600 text-white p-4 rounded-2xl font-black uppercase shadow-lg mt-4">
            üìä Resumo do Dia
        </button>

    </div>

    <!-- SOM -->
    <audio id="somChamada" preload="auto" loop></audio>

    <!-- SERVICE WORKER -->
    <script>
        // Criar SW via Blob
        const swCode = `
            self.addEventListener('install', e => self.skipWaiting());
            self.addEventListener('activate', e => self.clients.claim());
            self.addEventListener('push', e => {
                const data = e.data.json();
                e.waitUntil(
                    self.registration.showNotification('üîî NOVA CHAMADA!', {
                        body: data.body,
                        icon: 'https://cdn-icons-png.flaticon.com/512/2830/2830305.png',
                        vibrate: [500, 200, 500, 200, 500],
                        requireInteraction: true
                    })
                );
            });
            self.addEventListener('notificationclick', e => {
                e.notification.close();
                e.waitUntil(clients.openWindow('/'));
            });
        `;
        
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(swUrl)
                .then(() => {
                    console.log('SW ok');
                    if ('Notification' in window && Notification.permission !== 'granted') {
                        Notification.requestPermission();
                    }
                })
                .catch(err => console.log('SW erro:', err));
        }
        
        // VERIFICAR SE J√Å EST√Å INSTALADO
        let deferredPrompt = null;
        let podeInstalar = false;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            podeInstalar = true;
            document.getElementById('areaInstalar').classList.remove('hidden');
        });
        
        // Se n√£o aparecer o evento, mostrar bot√£o manual mesmo assim
        setTimeout(() => {
            if (!podeInstalar && !window.matchMedia('(display-mode: standalone)').matches) {
                document.getElementById('areaInstalar').classList.remove('hidden');
            }
        }, 3000);
        
        // FUN√á√ÉO INSTALAR (AUTOM√ÅTICA OU MANUAL)
        window.instalarManual = async () => {
            // Tentar m√©todo autom√°tico primeiro
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('areaInstalar').classList.add('hidden');
                    return;
                }
            }
            
            // Se n√£o funcionar, mostrar instru√ß√µes manuais
            const ua = navigator.userAgent.toLowerCase();
            let msg = '';
            
            if (ua.includes('chrome')) {
                msg = 'Toque no menu ‚ãÆ do Chrome e selecione "Adicionar √† tela inicial"';
            } else if (ua.includes('samsung')) {
                msg = 'Toque no menu ‚ãÆ e selecione "Adicionar p√°gina √†" ‚Üí Tela inicial';
            } else {
                msg = 'Toque no menu do navegador e procure "Adicionar √† tela inicial"';
            }
            
            alert('Para instalar:\n\n' + msg);
        };
    </script>

    <!-- FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBjP9dxFEp09DpZl5JkVMD05uaKoQTNDpE", 
            authDomain: "meuappentregas.firebaseapp.com", 
            projectId: "meuappentregas", 
            storageBucket: "meuappentregas.firebasestorage.app", 
            messagingSenderId: "442484186787", 
            appId: "1:442484186787:web:ac914827ebebda987f2916" 
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let online = false;
        let somAtivado = false;
        let chamadoAtual = null;
        let intervaloSom = null;
        let entregasHoje = [];

        // ATIVAR AUDIO
        function ativarAudio() {
            if (somAtivado) return;
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            function tocarBeep() {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }
            
            window.tocarSomChamada = () => {
                tocarBeep();
                intervaloSom = setInterval(tocarBeep, 2000);
            };
            
            window.pararSomChamada = () => {
                clearInterval(intervaloSom);
            };
            
            somAtivado = true;
        }

        document.addEventListener('click', ativarAudio, { once: true });
        document.addEventListener('touchstart', ativarAudio, { once: true });

        // MUDAR STATUS
        window.mudarStatus = async () => {
            online = !online;
            await setDoc(doc(db, 'config', 'status'), { online, ocupado: false }, { merge: true });
            
            if (online && 'wakeLock' in navigator) {
                try { await navigator.wakeLock.request('screen'); } catch (e) {}
            }
        };

        // LISTENER STATUS
        onSnapshot(doc(db, 'config', 'status'), (doc) => {
            const s = doc.data() || { online: false };
            online = s.online;
            const statusEl = document.getElementById('meuStatus');
            const btn = document.getElementById('btnStatus');
            const header = document.getElementById('headerStatus');
            
            if (online) {
                statusEl.textContent = '‚óè Online';
                statusEl.className = 'text-xl font-black text-green-600';
                btn.textContent = 'Ficar Offline';
                btn.className = 'bg-green-600 text-white px-6 py-3 rounded-xl font-black text-sm uppercase shadow-lg';
                header.classList.add('online-ativo');
            } else {
                statusEl.textContent = '‚óè Offline';
                statusEl.className = 'text-xl font-black text-red-600';
                btn.textContent = 'Ficar Online';
                btn.className = 'bg-red-500 text-white px-6 py-3 rounded-xl font-black text-sm uppercase shadow-lg';
                header.classList.remove('online-ativo');
            }
        });

        // LISTENER CHAMADAS
        onSnapshot(collection(db, 'chamadas'), (snap) => {
            const div = document.getElementById('areaChamadas');
            const notifFlutuante = document.getElementById('notificacaoFlutuante');
            
            let chamadoParaMim = null;
            snap.forEach((d) => {
                const c = d.data();
                if (c.status === 'Pendente') chamadoParaMim = { id: d.id, ...c };
            });

            if (chamadoParaMim && online) {
                if (chamadoAtual !== chamadoParaMim.id) {
                    chamadoAtual = chamadoParaMim.id;
                    
                    if (somAtivado && window.tocarSomChamada) window.tocarSomChamada();
                    
                    document.getElementById('nomeLojaChamada').textContent = chamadoParaMim.loja;
                    document.getElementById('enderecoLojaChamada').textContent = chamadoParaMim.enderecoLoja;
                    notifFlutuante.classList.remove('hidden');
                    
                    if (navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 500]);
                    
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('üîî NOVA CHAMADA!', {
                            body: `${chamadoParaMim.loja} - ${chamadoParaMim.enderecoLoja}`,
                            icon: 'https://cdn-icons-png.flaticon.com/512/2830/2830305.png',
                            vibrate: [500, 200, 500],
                            requireInteraction: true,
                            tag: 'chamada'
                        });
                    }
                }
            } else {
                if (!chamadoParaMim) {
                    notifFlutuante.classList.add('hidden');
                    chamadoAtual = null;
                    if (window.pararSomChamada) window.pararSomChamada();
                }
            }

            div.innerHTML = '';
            snap.forEach((d) => {
                const c = d.data();
                if (c.status === 'Pendente') {
                    div.innerHTML += `
                        <div class="bg-orange-500 text-white p-4 rounded-2xl shadow-lg mb-2 flex justify-between items-center">
                            <div>
                                <p class="font-black text-lg">üîî ${c.loja}</p>
                                <p class="text-xs">${c.enderecoLoja}</p>
                            </div>
                            <button onclick="aceitar('${d.id}')" class="bg-white text-orange-600 px-4 py-2 rounded-xl font-black text-lg">VOU!</button>
                        </div>
                    `;
                } else if (c.status === 'Visualizado') {
                    div.innerHTML += `
                        <div class="bg-slate-800 text-white p-3 rounded-xl border-l-4 border-green-500 mb-2 flex justify-between items-center">
                            <p class="font-black">${c.loja}</p>
                            <button onclick="pronto('${d.id}')" class="bg-green-600 text-white px-3 py-1 rounded-lg font-black text-xs">‚úÖ Pronto</button>
                        </div>
                    `;
                }
            });
        });

        window.aceitarChamadaFlutuante = () => {
            if (chamadoAtual) aceitar(chamadoAtual);
        };

        window.aceitar = async (id) => {
            if (window.pararSomChamada) window.pararSomChamada();
            await updateDoc(doc(db, 'chamadas', id), { status: 'Visualizado' });
            await setDoc(doc(db, 'config', 'status'), { online: true, ocupado: true }, { merge: true });
            document.getElementById('notificacaoFlutuante').classList.add('hidden');
        };

        window.pronto = async (id) => {
            await deleteDoc(doc(db, 'chamadas', id));
            await setDoc(doc(db, 'config', 'status'), { online: true, ocupado: false }, { merge: true });
        };

        // ENTREGAS
        onSnapshot(collection(db, 'pedidos'), (snap) => {
            const porLoja = {};
            entregasHoje = [];
            
            snap.forEach((d) => {
                const p = d.data();
                entregasHoje.push(p);
                if (p.status !== 'Concluido') {
                    if (!porLoja[p.loja]) porLoja[p.loja] = [];
                    porLoja[p.loja].push({ id: d.id, ...p });
                }
            });

            const div = document.getElementById('areaEntregas');
            const btnResumo = document.getElementById('btnResumo');
            const concluidas = entregasHoje.filter(e => e.status === 'Concluido').length;
            btnResumo.classList.toggle('hidden', concluidas === 0);
            btnResumo.innerHTML = `üìä Resumo (${concluidas} entregas)`;

            if (Object.keys(porLoja).length === 0) {
                div.innerHTML = '<p class="text-center text-gray-400 py-8">Nenhuma entrega üéâ</p>';
                return;
            }

            div.innerHTML = '<h2 class="font-black text-gray-800 uppercase mb-2">üì¶ Entregas</h2>';
            for (let loja in porLoja) {
                const entregas = porLoja[loja];
                div.innerHTML += `
                    <div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-4">
                        <div class="bg-blue-600 p-3 text-white">
                            <p class="font-black">${loja}</p>
                            <p class="text-xs">${entregas.length} entrega(s)</p>
                        </div>
                        <div class="p-3 space-y-2">
                            ${entregas.map(e => `
                                <div class="p-3 bg-gray-50 rounded-xl border-l-4 ${e.status === 'SaiuParaEntrega' ? 'border-orange-500' : 'border-blue-500'}">
                                    <p class="font-bold text-sm">${e.local}</p>
                                    <p class="text-xs text-blue-600 font-bold">${e.pag}</p>
                                    ${e.obs ? `<p class="text-xs text-orange-600 mt-1">‚ö†Ô∏è ${e.obs}</p>` : ''}
                                    <div class="flex gap-2 mt-2">
                                        ${e.status !== 'SaiuParaEntrega' ? `
                                            <button onclick="sair('${e.id}')" class="flex-1 bg-orange-500 text-white py-2 rounded-lg font-black text-sm">üõµ Sair</button>
                                        ` : `
                                            <button onclick="entregue('${e.id}', '${e.zap}')" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-black text-sm">‚úÖ Entregue</button>
                                        `}
                                        <button onclick="maps('${encodeURIComponent(e.local)}')" class="bg-blue-100 text-blue-600 px-3 rounded-lg font-black">üó∫Ô∏è</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        });

        window.sair = async (id) => {
            await updateDoc(doc(db, 'pedidos', id), { status: 'SaiuParaEntrega' });
        };

        window.entregue = async (id, zap) => {
            const nome = prompt('Quem recebeu?');
            if (!nome) return;
            await updateDoc(doc(db, 'pedidos', id), {
                status: 'Concluido',
                recebedor: nome,
                horaEntrega: Timestamp.now()
            });
            const msg = `‚úÖ Entregue!\n\nPara: ${nome}\n‚è∞ ${new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}`;
            window.open(`https://wa.me/55${zap}?text=${encodeURIComponent(msg)}`, '_blank');
        };

        window.maps = (end) => {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${end}`, '_blank');
        };

        window.gerarResumo = () => {
            const hoje = new Date().toLocaleDateString('pt-BR');
            const concluidas = entregasHoje.filter(e => e.status === 'Concluido');
            const porLoja = {};
            concluidas.forEach(e => {
                if (!porLoja[e.loja]) porLoja[e.loja] = [];
                porLoja[e.loja].push(e);
            });
            
            let texto = `üìä *RESUMO - ${hoje}*\n\n*Total:* ${concluidas.length} entregas\n\n`;
            for (let loja in porLoja) {
                texto += `*${loja}:*\n`;
                porLoja[loja].forEach((e, i) => {
                    texto += `${i+1}. ${e.local} | ${e.pag}\n`;
                });
                texto += '\n';
            }
            
            const meuZap = '14999999999';
            window.open(`https://wa.me/55${meuZap}?text=${encodeURIComponent(texto)}`, '_blank');
        };
    </script>
</body>
</html>
