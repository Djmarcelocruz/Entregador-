<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcelo - Entregador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, deleteDoc, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyBjP9dxFEp09DpZl5JkVMD05uaKoQTNDpE", authDomain: "meuappentregas.firebaseapp.com", projectId: "meuappentregas", storageBucket: "meuappentregas.firebasestorage.app", messagingSenderId: "442484186787", appId: "1:442484186787:web:ac914827ebebda987f2916" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        window.mudarStatus = async (s) => await setDoc(doc(db, "config", "status"), { online: s });
        onSnapshot(doc(db, "config", "status"), (d) => {
            const s = d.data()?.online;
            const b = document.getElementById('btnStatus');
            b.innerText = s ? "VOC√ä EST√Å ONLINE üü¢" : "VOC√ä EST√Å OFFLINE üî¥";
            b.className = s ? "w-full py-4 bg-green-500 text-white font-black rounded-xl mb-4" : "w-full py-4 bg-red-500 text-white font-black rounded-xl mb-4";
        });

        onSnapshot(query(collection(db, "chamados"), orderBy("timestamp", "desc")), (snaps) => {
            const cDiv = document.getElementById('chamadas'); cDiv.innerHTML = "";
            snaps.forEach(d => {
                const c = d.data();
                if(c.status === "Pendente") {
                    cDiv.innerHTML += `<div class="bg-yellow-100 p-4 rounded-xl mb-2 border-l-8 border-yellow-500">
                        <p class="font-bold">LOJA: ${c.loja}</p>
                        <div class="flex gap-2 mt-2">
                            <button onclick="responder('${d.id}','5m')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs">5 MIN</button>
                            <button onclick="responder('${d.id}','15m')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs">15 MIN</button>
                            <button onclick="responder('${d.id}','30m')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs">30 MIN</button>
                        </div>
                    </div>`;
                }
            });
        });

        onSnapshot(query(collection(db, "pedidos"), orderBy("timestamp", "asc")), (snaps) => {
            const pDiv = document.getElementById('pedidos'); pDiv.innerHTML = "";
            snaps.forEach(d => {
                const p = d.data();
                pDiv.innerHTML += `<div class="bg-white p-4 rounded-xl mb-2 shadow border-l-8 border-blue-600">
                    <p class="text-[10px] font-black uppercase text-gray-400">${p.loja}</p>
                    <p class="font-bold mb-2">${p.local}</p>
                    <div class="flex gap-2">
                        <a href="https://www.google.com/maps/search/${encodeURIComponent(p.local)}" target="_blank" class="bg-gray-100 p-2 rounded text-xs font-bold">MAPA üìç</a>
                        <button onclick="finalizar('${d.id}')" class="bg-green-500 text-white px-3 py-1 rounded text-xs font-bold">CONCLUIR ‚úÖ</button>
                    </div>
                </div>`;
            });
        });

        window.responder = async (id, t) => await updateDoc(doc(db, "chamados", id), { status: "Respondido", tempo: t });
        window.finalizar = async (id) => await deleteDoc(doc(db, "pedidos", id));
    </script>
</head>
<body class="bg-gray-200 p-4">
    <div class="max-w-md mx-auto">
        <button id="btnStatus" onclick="mudarStatus(this.innerText.includes('OFFLINE'))"></button>
        <div id="chamadas"></div>
        <h3 class="font-black text-xs text-gray-500 mb-2 uppercase">Entregas para Fazer</h3>
        <div id="pedidos"></div>
    </div>
</body>
</html>
