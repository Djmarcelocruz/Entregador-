<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcelo - Entregas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Manter tela sempre acesa quando online */
        .online-ativo { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        /* Notifica√ß√£o visual grande */
        .chamada-ativa { animation: shake 0.5s infinite; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body class="bg-slate-100 p-4 font-sans min-h-screen">
    <div class="max-w-md mx-auto pb-24">
        
        <!-- HEADER -->
        <div id="headerStatus" class="bg-white p-4 rounded-2xl shadow-lg mb-4 flex justify-between items-center">
            <div>
                <p class="text-xs font-bold text-gray-400 uppercase">Status</p>
                <p id="meuStatus" class="text-xl font-black text-red-600">‚óè Offline</p>
            </div>
            <button onclick="mudarStatus()" id="btnStatus" class="bg-red-500 text-white px-6 py-3 rounded-xl font-black text-sm uppercase shadow-lg">
                Ficar Online
            </button>
        </div>

        <!-- NOTIFICA√á√ÉO FLUTUANTE (QUANDO CHAMADO) -->
        <div id="notificacaoFlutuante" class="hidden fixed top-4 left-4 right-4 bg-red-600 text-white p-6 rounded-2xl shadow-2xl z-50 chamada-ativa">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-bold uppercase mb-1">üîî NOVA CHAMADA!</p>
                    <p id="nomeLojaChamada" class="text-2xl font-black">Loja</p>
                    <p id="enderecoLojaChamada" class="text-sm opacity-90 mt-1">Endere√ßo</p>
                </div>
                <button onclick="aceitarChamadaFlutuante()" class="bg-white text-red-600 px-6 py-3 rounded-xl font-black text-lg shadow-lg">
                    VOU! üèçÔ∏è
                </button>
            </div>
        </div>

        <!-- CHAMADAS NORMAIS -->
        <div id="areaChamadas" class="mb-4"></div>

        <!-- ENTREGAS -->
        <div id="areaEntregas" class="space-y-4"></div>

        <!-- RESUMO -->
        <button id="btnResumo" onclick="gerarResumo()" class="hidden w-full bg-purple-600 text-white p-4 rounded-2xl font-black uppercase shadow-lg mt-4">
            üìä Ver Resumo do Dia
        </button>

    </div>

    <!-- SOM ALTO E REPETITIVO -->
    <audio id="somChamada" preload="auto" loop></audio>
    <audio id="somEntrega" preload="auto"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBjP9dxFEp09DpZl5JkVMD05uaKoQTNDpE", 
            authDomain: "meuappentregas.firebaseapp.com", 
            projectId: "meuappentregas", 
            storageBucket: "meuappentregas.firebasestorage.app", 
            messagingSenderId: "442484186787", 
            appId: "1:442484186787:web:ac914827ebebda987f2916" 
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let online = false;
        let somAtivado = false;
        let chamadoAtual = null;
        let intervaloSom = null;
        let entregasHoje = [];

        // ATIVAR SOM NA PRIMEIRA INTERA√á√ÉO (OBRIGAT√ìRIO NOS NAVEGADORES)
        function ativarAudio() {
            if (somAtivado) return;
            
            const somChamada = document.getElementById('somChamada');
            const somEntrega = document.getElementById('somEntrega');
            
            // Som de campainha (beep repetitivo)
            somChamada.src = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=';
            
            // Som de notifica√ß√£o mais elaborado
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            function tocarBeep() {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }
            
            // Tocar beep a cada 2 segundos quando chamado
            window.tocarSomChamada = () => {
                tocarBeep();
                intervaloSom = setInterval(tocarBeep, 2000);
            };
            
            window.pararSomChamada = () => {
                clearInterval(intervaloSom);
            };
            
            somAtivado = true;
            console.log('Audio ativado');
        }

        // TENTAR ATIVAR EM QUALQUER CLIQUE
        document.addEventListener('click', ativarAudio, { once: true });
        document.addEventListener('touchstart', ativarAudio, { once: true });

        // MUDAR STATUS
        window.mudarStatus = async () => {
            online = !online;
            await setDoc(doc(db, 'config', 'status'), { online, ocupado: false }, { merge: true });
            
            // Manter tela acesa quando online (wake lock)
            if (online && 'wakeLock' in navigator) {
                try {
                    await navigator.wakeLock.request('screen');
                } catch (e) {
                    console.log('Wake lock n√£o dispon√≠vel');
                }
            }
        };

        // LISTENER STATUS
        onSnapshot(doc(db, 'config', 'status'), (doc) => {
            const s = doc.data() || { online: false };
            online = s.online;
            
            const statusEl = document.getElementById('meuStatus');
            const btn = document.getElementById('btnStatus');
            const header = document.getElementById('headerStatus');
            
            if (online) {
                statusEl.textContent = '‚óè Online';
                statusEl.className = 'text-xl font-black text-green-600';
                btn.textContent = 'Ficar Offline';
                btn.className = 'bg-green-600 text-white px-6 py-3 rounded-xl font-black text-sm uppercase shadow-lg';
                header.classList.add('online-ativo');
            } else {
                statusEl.textContent = '‚óè Offline';
                statusEl.className = 'text-xl font-black text-red-600';
                btn.textContent = 'Ficar Online';
                btn.className = 'bg-red-500 text-white px-6 py-3 rounded-xl font-black text-sm uppercase shadow-lg';
                header.classList.remove('online-ativo');
            }
        });

        // LISTENER CHAMADAS
        onSnapshot(collection(db, 'chamadas'), (snap) => {
            const div = document.getElementById('areaChamadas');
            const notifFlutuante = document.getElementById('notificacaoFlutuante');
            
            // Verificar se tem chamada nova para mim
            let chamadoParaMim = null;
            
            snap.forEach((d) => {
                const c = d.data();
                if (c.status === 'Pendente') {
                    chamadoParaMim = { id: d.id, ...c };
                }
            });

            // SE TEM CHAMADA NOVA E ESTOU ONLINE
            if (chamadoParaMim && online) {
                // Se √© um chamado diferente do atual, tocar som
                if (chamadoAtual !== chamadoParaMim.id) {
                    chamadoAtual = chamadoParaMim.id;
                    
                    // Tocar som repetitivo
                    if (somAtivado && window.tocarSomChamada) {
                        window.tocarSomChamada();
                    }
                    
                    // Mostrar notifica√ß√£o flutuante grande
                    document.getElementById('nomeLojaChamada').textContent = chamadoParaMim.loja;
                    document.getElementById('enderecoLojaChamada').textContent = chamadoParaMim.enderecoLoja;
                    notifFlutuante.classList.remove('hidden');
                    
                    // Vibrar se poss√≠vel
                    if (navigator.vibrate) {
                        navigator.vibrate([500, 200, 500, 200, 500]);
                    }
                    
                    // Tentar notifica√ß√£o do navegador
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('üîî NOVA CHAMADA!', {
                            body: `${chamadoParaMim.loja} - ${chamadoParaMim.enderecoLoja}`,
                            icon: 'üèçÔ∏è',
                            requireInteraction: true
                        });
                    } else if ('Notification' in window && Notification.permission !== 'denied') {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                new Notification('üîî NOVA CHAMADA!', {
                                    body: `${chamadoParaMim.loja}`,
                                    requireInteraction: true
                                });
                            }
                        });
                    }
                }
            } else {
                // Esconder notifica√ß√£o se n√£o tem chamada
                if (!chamadoParaMim) {
                    notifFlutuante.classList.add('hidden');
                    chamadoAtual = null;
                    if (window.pararSomChamada) window.pararSomChamada();
                }
            }

            // Renderizar lista normal de chamadas
            div.innerHTML = '';
            snap.forEach((d) => {
                const c = d.data();
                
                if (c.status === 'Pendente') {
                    div.innerHTML += `
                        <div class="bg-orange-500 text-white p-4 rounded-2xl shadow-lg mb-2 flex justify-between items-center">
                            <div>
                                <p class="font-black text-lg">üîî ${c.loja}</p>
                                <p class="text-xs">${c.enderecoLoja}</p>
                            </div>
                            <button onclick="aceitar('${d.id}')" class="bg-white text-orange-600 px-4 py-2 rounded-xl font-black text-lg">VOU!</button>
                        </div>
                    `;
                } else if (c.status === 'Visualizado') {
                    div.innerHTML += `
                        <div class="bg-slate-800 text-white p-3 rounded-xl border-l-4 border-green-500 mb-2 flex justify-between items-center">
                            <p class="font-black">${c.loja}</p>
                            <button onclick="pronto('${d.id}')" class="bg-green-600 text-white px-3 py-1 rounded-lg font-black text-xs">‚úÖ Pronto</button>
                        </div>
                    `;
                }
            });
        });

        // ACEITAR CHAMADA FLUTUANTE
        window.aceitarChamadaFlutuante = () => {
            if (chamadoAtual) {
                aceitar(chamadoAtual);
            }
        };

        window.aceitar = async (id) => {
            // Parar som
            if (window.pararSomChamada) window.pararSomChamada();
            
            await updateDoc(doc(db, 'chamadas', id), { status: 'Visualizado' });
            await setDoc(doc(db, 'config', 'status'), { online: true, ocupado: true }, { merge: true });
            
            // Esconder notifica√ß√£o flutuante
            document.getElementById('notificacaoFlutuante').classList.add('hidden');
        };

        window.pronto = async (id) => {
            await deleteDoc(doc(db, 'chamadas', id));
            await setDoc(doc(db, 'config', 'status'), { online: true, ocupado: false }, { merge: true });
        };

        // ENTREGAS (SIMPLIFICADO)
        onSnapshot(collection(db, 'pedidos'), (snap) => {
            const porLoja = {};
            entregasHoje = [];
            
            snap.forEach((d) => {
                const p = d.data();
                entregasHoje.push(p);
                
                if (p.status !== 'Concluido') {
                    if (!porLoja[p.loja]) porLoja[p.loja] = [];
                    porLoja[p.loja].push({ id: d.id, ...p });
                }
            });

            const div = document.getElementById('areaEntregas');
            const btnResumo = document.getElementById('btnResumo');
            
            const concluidas = entregasHoje.filter(e => e.status === 'Concluido').length;
            btnResumo.classList.toggle('hidden', concluidas === 0);
            btnResumo.innerHTML = `üìä Resumo (${concluidas} entregas)`;

            if (Object.keys(porLoja).length === 0) {
                div.innerHTML = '<p class="text-center text-gray-400 py-8">Nenhuma entrega üéâ</p>';
                return;
            }

            div.innerHTML = '<h2 class="font-black text-gray-800 uppercase mb-2">üì¶ Entregas</h2>';
            
            for (let loja in porLoja) {
                const entregas = porLoja[loja];
                
                div.innerHTML += `
                    <div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-4">
                        <div class="bg-blue-600 p-3 text-white">
                            <p class="font-black">${loja}</p>
                            <p class="text-xs">${entregas.length} entrega(s)</p>
                        </div>
                        <div class="p-3 space-y-2">
                            ${entregas.map(e => `
                                <div class="p-3 bg-gray-50 rounded-xl border-l-4 ${e.status === 'SaiuParaEntrega' ? 'border-orange-500' : 'border-blue-500'}">
                                    <p class="font-bold text-sm">${e.local}</p>
                                    <p class="text-xs text-blue-600 font-bold">${e.pag}</p>
                                    ${e.obs ? `<p class="text-xs text-orange-600 mt-1">‚ö†Ô∏è ${e.obs}</p>` : ''}
                                    
                                    <div class="flex gap-2 mt-2">
                                        ${e.status !== 'SaiuParaEntrega' ? `
                                            <button onclick="sair('${e.id}')" class="flex-1 bg-orange-500 text-white py-2 rounded-lg font-black text-sm">üõµ Sair</button>
                                        ` : `
                                            <button onclick="entregue('${e.id}', '${e.zap}')" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-black text-sm">‚úÖ Entregue</button>
                                        `}
                                        <button onclick="maps('${encodeURIComponent(e.local)}')" class="bg-blue-100 text-blue-600 px-3 rounded-lg font-black">üó∫Ô∏è</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        });

        window.sair = async (id) => {
            await updateDoc(doc(db, 'pedidos', id), { status: 'SaiuParaEntrega' });
        };

        window.entregue = async (id, zap) => {
            const nome = prompt('Quem recebeu?');
            if (!nome) return;
            
            await updateDoc(doc(db, 'pedidos', id), {
                status: 'Concluido',
                recebedor: nome,
                horaEntrega: Timestamp.now()
            });
            
            const msg = `‚úÖ Entregue!\n\nPara: ${nome}\n‚è∞ ${new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}`;
            window.open(`https://wa.me/55${zap}?text=${encodeURIComponent(msg)}`, '_blank');
        };

        window.maps = (end) => {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${end}`, '_blank');
        };

        window.gerarResumo = () => {
            const hoje = new Date().toLocaleDateString('pt-BR');
            const concluidas = entregasHoje.filter(e => e.status === 'Concluido');
            
            const porLoja = {};
            concluidas.forEach(e => {
                if (!porLoja[e.loja]) porLoja[e.loja] = [];
                porLoja[e.loja].push(e);
            });
            
            let texto = `üìä *RESUMO - ${hoje}*\n\n*Total:* ${concluidas.length} entregas\n\n`;
            
            for (let loja in porLoja) {
                texto += `*${loja}:*\n`;
                porLoja[loja].forEach((e, i) => {
                    texto += `${i+1}. ${e.local} | ${e.pag}\n`;
                });
                texto += '\n';
            }
            
            const meuZap = '14999999999'; // N√∫mero do Marcelo
            window.open(`https://wa.me/55${meuZap}?text=${encodeURIComponent(texto)}`, '_blank');
        };
    </script>
</body>
</html>
