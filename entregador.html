<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Marcelo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyBjP9dxFEp09DpZl5JkVMD05uaKoQTNDpE", authDomain: "meuappentregas.firebaseapp.com", projectId: "meuappentregas", storageBucket: "meuappentregas.firebasestorage.app", messagingSenderId: "442484186787", appId: "1:442484186787:web:ac914827ebebda987f2916" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        let fechamentoLote = {};

        window.mudarStatus = async (tipo, val) => {
            const ref = doc(db, "config", "status");
            await setDoc(ref, { [tipo]: val }, { merge: true });
        };

        onSnapshot(doc(db, "config", "status"), (d) => {
            const s = d.data();
            document.getElementById('btnOn').innerText = s?.online ? "ONLINE" : "OFFLINE";
            document.getElementById('btnOn').className = s?.online ? "flex-1 py-4 bg-green-500 text-white font-bold rounded-2xl" : "flex-1 py-4 bg-red-500 text-white font-bold rounded-2xl";
            document.getElementById('btnOcu').className = s?.ocupado ? "flex-1 py-4 bg-orange-500 text-white font-bold rounded-2xl" : "flex-1 py-4 bg-gray-300 text-white font-bold rounded-2xl";
        });

        onSnapshot(query(collection(db, "pedidos"), orderBy("timestamp", "asc")), (snaps) => {
            const div = document.getElementById('corpo'); div.innerHTML = "";
            let lojas = {};
            snaps.forEach(d => {
                const p = d.data();
                if(!lojas[p.loja]) lojas[p.loja] = [];
                lojas[p.loja].push({id: d.id, ...p});
            });

            for (let loja in lojas) {
                div.innerHTML += `
                <div class="bg-white p-5 rounded-[35px] shadow-xl mb-6 border-t-8 border-blue-600">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-black text-blue-900 uppercase">${loja}</h2>
                        <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-xs font-bold">${lojas[loja].length} entregas</span>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-2xl mb-4 border-2 border-blue-50">
                        <p class="text-[10px] font-bold text-gray-400 mb-1 uppercase text-center">Definir Valor do Lote Todo (R$)</p>
                        <input type="number" placeholder="Ex: 50.00" oninput="ajustarValores('${loja}', this.value)" class="w-full bg-transparent text-center font-black text-2xl text-blue-600 outline-none">
                    </div>

                    <div id="lista-${loja}" class="space-y-3">
                        ${lojas[loja].map(ent => `
                            <div class="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                                <p class="font-bold text-sm mb-2 text-gray-700">${ent.local}</p>
                                <div class="flex items-center gap-2">
                                    <input id="val-${ent.id}" type="number" value="7.00" class="w-20 bg-white p-2 rounded-lg font-black text-green-600 text-sm border">
                                    <button onclick="finalizar('${ent.id}', '${loja}', '${ent.local}', document.getElementById('val-${ent.id}').value, '${ent.zap}')" class="flex-1 bg-blue-600 text-white font-bold py-2 rounded-xl text-xs">CONCLUIR</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="enviarZap('${loja}')" id="btnZap-${loja}" class="hidden w-full mt-4 bg-green-500 text-white font-black py-4 rounded-2xl shadow-lg italic uppercase">Enviar Fechamento WhatsApp</button>
                </div>`;
            }
        });

        window.ajustarValores = (loja, total) => {
            const inputs = document.querySelectorAll(`[id^="val-"]`);
            const qtd = document.querySelectorAll(`#lista-${loja} > div`).length;
            const unitario = (total / qtd).toFixed(2);
            inputs.forEach(input => {
                if(input.closest(`#lista-${loja}`)) input.value = unitario;
            });
        };

        window.finalizar = async (id, loja, local, valor, zap) => {
            const hora = new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
            if(!fechamentoLote[loja]) fechamentoLote[loja] = { zap: zap, itens: [], total: 0 };
            fechamentoLote[loja].itens.push(`ðŸ“ ${local} | â° ${hora} | R$ ${valor}`);
            fechamentoLote[loja].total += parseFloat(valor);
            await deleteDoc(doc(db, "pedidos", id));
            document.getElementById(`btnZap-${loja}`).classList.remove('hidden');
        };

        window.enviarZap = (l) => {
            const d = fechamentoLote[l];
            const msg = window.encodeURIComponent(`*FECHAMENTO MARCELO*\n\nâœ… *LOJA: ${l}*\n\n${d.itens.join('\n')}\n\n*TOTAL: R$ ${d.total.toFixed(2)}*`);
            window.open(`https://api.whatsapp.com/send?phone=55${d.zap}&text=${msg}`);
            delete fechamentoLote[l]; location.reload();
        };
    </script>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-md mx-auto">
        <div class="flex gap-2 mb-6 shadow-xl">
            <button id="btnOn" onclick="mudarStatus('online', this.innerText === 'OFFLINE')"></button>
            <button id="btnOcu" onclick="mudarStatus('ocupado', this.classList.contains('bg-gray-300'))">OCUPADO ðŸ›µ</button>
        </div>
        <div id="corpo"></div>
    </div>
</body>
</html>
