<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcelo Entregas</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 p-4">
    <div class="max-w-md mx-auto">
        <div id="avisoSom" class="bg-blue-600 text-white p-4 rounded-2xl mb-4 text-center font-black animate-pulse cursor-pointer" onclick="this.remove()">
            CLIQUE AQUI PARA ATIVAR O SOM üîä
        </div>

        <div class="bg-white p-4 rounded-3xl shadow-lg mb-4 flex justify-around">
            <div class="text-center"><p class="text-[9px] font-black italic">CONCLU√çDAS</p><p id="totalDia" class="text-2xl font-black text-blue-600">0</p></div>
            <div class="text-center"><p class="text-[9px] font-black italic">MEU STATUS</p><div id="stTrabalho" class="text-xs font-black uppercase">...</div></div>
        </div>

        <div id="listaChamadas" class="mb-4 space-y-2"></div>
        <div id="entregas" class="space-y-6"></div>
    </div>

    <audio id="som" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBjP9dxFEp09DpZl5JkVMD05uaKoQTNDpE", authDomain: "meuappentregas.firebaseapp.com", projectId: "meuappentregas", storageBucket: "meuappentregas.firebasestorage.app", messagingSenderId: "442484186787", appId: "1:442484186787:web:ac914827ebebda987f2916" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        let memoriaRelatorio = JSON.parse(localStorage.getItem('relatorio_marcelo')) || {};
        let ultimaQtd = 0;

        // Monitorar Chamadas
        onSnapshot(collection(db, "chamadas"), (snaps) => {
            const div = document.getElementById('listaChamadas');
            div.innerHTML = '';
            if(snaps.size > ultimaQtd) { document.getElementById('som').play().catch(()=>{}); }
            ultimaQtd = snaps.size;

            snaps.forEach(d => {
                const c = d.data();
                if(c.status === "Pendente") {
                    div.innerHTML += `<div class="bg-orange-500 text-white p-4 rounded-2xl flex justify-between items-center shadow-lg mb-2 border-2 border-white"><div><p class="font-black text-xs">üîî ${c.loja}</p><p class="text-[8px] uppercase">${c.enderecoLoja}</p></div><button onclick="ver('${d.id}')" class="bg-white text-orange-600 px-4 py-2 rounded-xl font-black text-xs">OK!</button></div>`;
                } else {
                    div.innerHTML += `<div class="bg-slate-800 text-white p-3 rounded-xl flex justify-between items-center mb-2 border-l-8 border-green-500"><div class="text-[9px] font-black uppercase">${c.loja}</div><button onclick="limpar('${d.id}')" class="bg-red-500 px-3 py-1 rounded text-[8px]">COLETEI</button></div>`;
                }
            });
        });

        window.ver = async (id) => await updateDoc(doc(db, "chamadas", id), { status: "Visualizado" });
        window.limpar = async (id) => await deleteDoc(doc(db, "chamadas", id));

        // Monitorar Pedidos
        onSnapshot(collection(db, "pedidos"), (snaps) => {
            let porLoja = {};
            snaps.forEach(d => {
                const p = {id: d.id, ...d.data()};
                if(!porLoja[p.loja]) porLoja[p.loja] = [];
                porLoja[p.loja].push(p);
            });

            const divGeral = document.getElementById('entregas');
            divGeral.innerHTML = '';
            
            for (let loja in porLoja) {
                divGeral.innerHTML += `
                <div class="bg-white rounded-3xl shadow-xl mb-6 p-4 border-t-8 border-blue-600">
                    <h2 class="font-black text-blue-900 mb-4 text-xs italic uppercase">${loja}</h2>
                    <div class="space-y-3">
                        ${porLoja[loja].map(p => `
                        <div class="p-3 bg-gray-50 rounded-2xl border-l-4 border-orange-500">
                            <p class="text-[10px] font-black uppercase">${p.local}</p>
                            <p class="text-[8px] font-bold text-gray-400 mb-2">${p.pag}</p>
                            <div class="flex gap-2">
                                <input id="rec-${p.id}" placeholder="Quem recebeu?" class="flex-1 p-2 rounded-lg border text-[10px]">
                                <button onclick="concluir('${p.id}','${loja}','${p.local}','${p.zap}','${p.pag}')" class="bg-green-600 text-white px-4 rounded-xl font-black">‚úì</button>
                            </div>
                        </div>`).join('')}
                    </div>
                </div>`;
            }

            // Exibir bot√µes de finalizar para lojas conclu√≠das
            for (let l in memoriaRelatorio) {
                if (!porLoja[l]) {
                    divGeral.innerHTML += `<div class="bg-purple-600 p-6 rounded-3xl text-center mb-10"><p class="text-white font-black text-xs mb-4 uppercase italic">${l} CONCLU√çDA!</p><button onclick="zap('${l}')" class="w-full bg-white text-purple-700 p-4 rounded-2xl font-black text-xs">ENVIAR RELAT√ìRIO WHATSAPP</button></div>`;
                }
            }
            atualizarContador();
        });

        window.concluir = async (id, loja, local, zap, pag) => {
            const rec = document.getElementById(`rec-${id}`).value || "N/I";
            if(!memoriaRelatorio[loja]) memoriaRelatorio[loja] = { zap, itens: [] };
            memoriaRelatorio[loja].itens.push(`‚úÖ *${local}*\nüí∞ ${pag}\nüë§ Rec: ${rec}`);
            localStorage.setItem('relatorio_marcelo', JSON.stringify(memoriaRelatorio));
            await deleteDoc(doc(db, "pedidos", id));
        };

        window.zap = (loja) => {
            const r = memoriaRelatorio[loja];
            const msg = `*FECHAMENTO MARCELO*\n\n${r.itens.join('\n\n')}`;
            window.open(`https://wa.me/55${r.zap}?text=${encodeURIComponent(msg)}`);
            delete memoriaRelatorio[loja];
            localStorage.setItem('relatorio_marcelo', JSON.stringify(memoriaRelatorio));
            location.reload();
        };

        function atualizarContador() {
            let total = 0;
            for(let l in memoriaRelatorio) total += memoriaRelatorio[l].itens.length;
            document.getElementById('totalDia').innerText = total;
        }

        onSnapshot(doc(db, "config", "status"), (d) => {
            const s = d.data() || { online: false };
            document.getElementById('stTrabalho').innerText = s.online ? "ONLINE" : "OFFLINE";
        });
    </script>
</body>
</html>
