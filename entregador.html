<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcelo - Entregas</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 p-4 font-sans min-h-screen">
    <div class="max-w-md mx-auto pb-24">
        
        <!-- STATUS -->
        <div class="bg-white p-4 rounded-2xl shadow-lg mb-4 flex justify-between items-center">
            <div>
                <p class="text-xs font-bold text-gray-400 uppercase">Status</p>
                <p id="meuStatus" class="text-xl font-black text-red-600">‚óè Offline</p>
            </div>
            <button onclick="mudarStatus()" id="btnStatus" class="bg-red-500 text-white px-6 py-3 rounded-xl font-black text-sm uppercase shadow-lg">
                Ficar Online
            </button>
        </div>

        <!-- CHAMADAS -->
        <div id="areaChamadas" class="mb-4"></div>

        <!-- ENTREGAS -->
        <div id="areaEntregas" class="space-y-4"></div>

        <!-- RESUMO DO DIA (APARECE QUANDO TEM ENTREGAS) -->
        <button id="btnResumo" onclick="gerarResumo()" class="hidden w-full bg-purple-600 text-white p-4 rounded-2xl font-black uppercase shadow-lg mt-4">
            üìä Ver Resumo do Dia
        </button>

    </div>

    <audio id="som" preload="auto"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBjP9dxFEp09DpZl5JkVMD05uaKoQTNDpE", 
            authDomain: "meuappentregas.firebaseapp.com", 
            projectId: "meuappentregas", 
            storageBucket: "meuappentregas.firebasestorage.app", 
            messagingSenderId: "442484186787", 
            appId: "1:442484186787:web:ac914827ebebda987f2916" 
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let online = false;
        let somAtivado = false;
        let entregasHoje = [];

        // SOM NO PRIMEIRO CLIQUE
        document.body.addEventListener('click', () => {
            if (!somAtivado) {
                document.getElementById('som').src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZSA0PVanu8LdnGgU1k9n1unEiBC13yO/eizEIHWq+8+OZURE';
                document.getElementById('som').play().catch(() => {});
                somAtivado = true;
            }
        }, { once: true });

        window.mudarStatus = async () => {
            online = !online;
            await setDoc(doc(db, 'config', 'status'), { online, ocupado: false }, { merge: true });
        };

        onSnapshot(doc(db, 'config', 'status'), (doc) => {
            const s = doc.data() || { online: false };
            online = s.online;
            const statusEl = document.getElementById('meuStatus');
            const btn = document.getElementById('btnStatus');
            
            if (online) {
                statusEl.textContent = '‚óè Online';
                statusEl.className = 'text-xl font-black text-green-600';
                btn.textContent = 'Ficar Offline';
                btn.className = 'bg-green-600 text-white px-6 py-3 rounded-xl font-black text-sm uppercase shadow-lg';
            } else {
                statusEl.textContent = '‚óè Offline';
                statusEl.className = 'text-xl font-black text-red-600';
                btn.textContent = 'Ficar Online';
                btn.className = 'bg-red-500 text-white px-6 py-3 rounded-xl font-black text-sm uppercase shadow-lg';
            }
        });

        onSnapshot(collection(db, 'chamadas'), (snap) => {
            const div = document.getElementById('areaChamadas');
            
            if (!online || snap.empty) {
                div.innerHTML = '';
                return;
            }
            
            if (somAtivado) document.getElementById('som').play().catch(() => {});
            
            div.innerHTML = '<h2 class="font-black text-gray-800 uppercase mb-2">üîî Chamadas</h2>';
            
            snap.forEach((d) => {
                const c = d.data();
                if (c.status === 'Pendente') {
                    div.innerHTML += `
                        <div class="bg-orange-500 text-white p-4 rounded-2xl shadow-lg mb-2 flex justify-between items-center">
                            <div>
                                <p class="font-black text-lg">${c.loja}</p>
                                <p class="text-xs">${c.enderecoLoja}</p>
                            </div>
                            <button onclick="aceitar('${d.id}')" class="bg-white text-orange-600 px-4 py-2 rounded-xl font-black">VOU!</button>
                        </div>
                    `;
                } else {
                    div.innerHTML += `
                        <div class="bg-slate-800 text-white p-3 rounded-xl border-l-4 border-green-500 mb-2 flex justify-between items-center">
                            <p class="font-black">${c.loja}</p>
                            <button onclick="pronto('${d.id}')" class="bg-green-600 text-white px-3 py-1 rounded-lg font-black text-xs">‚úÖ Pronto</button>
                        </div>
                    `;
                }
            });
        });

        window.aceitar = async (id) => {
            await updateDoc(doc(db, 'chamadas', id), { status: 'Visualizado' });
            await setDoc(doc(db, 'config', 'status'), { online: true, ocupado: true }, { merge: true });
        };

        window.pronto = async (id) => {
            await deleteDoc(doc(db, 'chamadas', id));
            await setDoc(doc(db, 'config', 'status'), { online: true, ocupado: false }, { merge: true });
        };

        onSnapshot(collection(db, 'pedidos'), (snap) => {
            const porLoja = {};
            entregasHoje = [];
            
            snap.forEach((d) => {
                const p = d.data();
                entregasHoje.push(p);
                
                if (p.status !== 'Concluido') {
                    if (!porLoja[p.loja]) porLoja[p.loja] = [];
                    porLoja[p.loja].push({ id: d.id, ...p });
                }
            });

            const div = document.getElementById('areaEntregas');
            const btnResumo = document.getElementById('btnResumo');
            
            // Mostrar bot√£o de resumo se tem entregas hoje
            const concluidasHoje = entregasHoje.filter(e => e.status === 'Concluido').length;
            btnResumo.classList.toggle('hidden', concluidasHoje === 0);
            btnResumo.innerHTML = `üìä Ver Resumo do Dia (${concluidasHoje} entregas)`;

            if (Object.keys(porLoja).length === 0) {
                div.innerHTML = '<p class="text-center text-gray-400 py-8">Nenhuma entrega pendente üéâ</p>';
                return;
            }

            div.innerHTML = '<h2 class="font-black text-gray-800 uppercase mb-2">üì¶ Entregas</h2>';
            
            for (let loja in porLoja) {
                const entregas = porLoja[loja];
                
                div.innerHTML += `
                    <div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-4">
                        <div class="bg-blue-600 p-3 text-white">
                            <p class="font-black">${loja}</p>
                            <p class="text-xs">${entregas.length} entrega(s)</p>
                        </div>
                        <div class="p-3 space-y-2">
                            ${entregas.map(e => `
                                <div class="p-3 bg-gray-50 rounded-xl border-l-4 ${e.status === 'SaiuParaEntrega' ? 'border-orange-500' : 'border-blue-500'}">
                                    <p class="font-bold text-sm">${e.local}</p>
                                    <p class="text-xs text-blue-600 font-bold">${e.pag}</p>
                                    ${e.obs ? `<p class="text-xs text-orange-600 mt-1">‚ö†Ô∏è ${e.obs}</p>` : ''}
                                    
                                    <div class="flex gap-2 mt-2">
                                        ${e.status !== 'SaiuParaEntrega' ? `
                                            <button onclick="sair('${e.id}')" class="flex-1 bg-orange-500 text-white py-2 rounded-lg font-black text-sm">üõµ Sair</button>
                                        ` : `
                                            <button onclick="entregue('${e.id}', '${e.zap}')" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-black text-sm">‚úÖ Entregue</button>
                                        `}
                                        <button onclick="maps('${encodeURIComponent(e.local)}')" class="bg-blue-100 text-blue-600 px-3 rounded-lg font-black">üó∫Ô∏è</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        });

        window.sair = async (id) => {
            await updateDoc(doc(db, 'pedidos', id), { status: 'SaiuParaEntrega' });
        };

        window.entregue = async (id, zap) => {
            const nome = prompt('Quem recebeu?');
            if (!nome) return;
            
            await updateDoc(doc(db, 'pedidos', id), {
                status: 'Concluido',
                recebedor: nome,
                horaEntrega: Timestamp.now()
            });
            
            const msg = `‚úÖ Entregue!\n\nPara: ${nome}\n‚è∞ ${new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}`;
            window.open(`https://wa.me/55${zap}?text=${encodeURIComponent(msg)}`, '_blank');
        };

        window.maps = (end) => {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${end}`, '_blank');
        };

        // GERAR RESUMO DO DIA
        window.gerarResumo = () => {
            const hoje = new Date().toLocaleDateString('pt-BR');
            const concluidas = entregasHoje.filter(e => e.status === 'Concluido');
            
            // Agrupar por loja
            const porLoja = {};
            concluidas.forEach(e => {
                if (!porLoja[e.loja]) porLoja[e.loja] = [];
                porLoja[e.loja].push(e);
            });
            
            let texto = `üìä *RESUMO DO DIA - ${hoje}*\n\n`;
            texto += `*Total de entregas:* ${concluidas.length}\n\n`;
            
            for (let loja in porLoja) {
                texto += `*${loja}:*\n`;
                porLoja[loja].forEach((e, i) => {
                    const hora = e.horaEntrega?.toDate?.() || new Date();
                    texto += `${i+1}. ${e.local}\n`;
                    texto += `   üí∞ ${e.pag}\n`;
                    texto += `   üë§ ${e.recebedor} (${hora.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})})\n\n`;
                });
            }
            
            texto += `\n‚úÖ Trabalho finalizado!`;
            
            // Enviar para WhatsApp do pr√≥prio Marcelo (ou salvar)
            const meuZap = '14999999999'; // Colocar o n√∫mero do Marcelo aqui
            window.open(`https://wa.me/55${meuZap}?text=${encodeURIComponent(texto)}`, '_blank');
        };
    </script>
</body>
</html>
